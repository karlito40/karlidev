<!doctype html>
<html class="theme-next use-motion">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>




  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.3.0rc1"/>


    <meta name="description" content="Node et Javascript en pratique: tutoriels, exemple et experimentation." />



    <meta name="keywords" content="Javascript, Node, Mongo, PHP, Go, Git, Benchmark, Developpeur web" />





    <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.3.0rc1" />


<style>
body{
	word-spacing:2px;
}

</style>


  <title> Web extension, créer une sidebar // Journal de bord d'un développeur </title>
</head>

<body>
  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
    <a href="/" class="brand">
        <span class="logo">
          <i class="icon-logo"></i>
        </span>
        <span class="site-title">Karlidev</span>
    </a>
</h1>


  <ul id="menu" class="menu">
    
      
      <li class="menu-item menu-item-home">
        <a href="/">
          <i class="menu-item-icon icon-home"></i> <br />
          Accueil
        </a>
      </li>
    
      
      <li class="menu-item menu-item-archives">
        <a href="/archives">
          <i class="menu-item-icon icon-archives"></i> <br />
          Archives
        </a>
      </li>
    
      
      <li class="menu-item menu-item-tags">
        <a href="/tags">
          <i class="menu-item-icon icon-tags"></i> <br />
          Tags
        </a>
      </li>
    
  </ul>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
            
          

          <div id="posts" class="posts-expand">
            
  

  <div class="post post-type-normal ">
    <div class="post-header">
      
      
        <h1 class="post-title">
          
          
            
              Web extension, créer une sidebar
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posté le 22/09/2018
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <p>Dans l’épisode précédent, nous avons étudié l’<a href="/2018/09/16/web-extension-injecter-une-iframe">injection d’iframe</a> dans une Web extension. Nous savons désormais qu’il est possible d’intégrer du contenu à un site web en limitant l’altération de son style et sa structure.</p>
<p>Mon envie maintenant est de me servir de ce que nous avons appris pour créer un panel ajustable et paramétrable. Comme des images sont plus parlantes que des mots, je vous présente le prototype issue de cet article.</p>
<figure class="caption-img"><br>  <img src="/images/web-extension/sidebar-panel.png" alt="SidebarPanel"><br>  <figcaption><strong><em>SidebarPanel</em></strong> <em>Affiche un cadre (ou panel) sur le coté gauche du site visité</em></figcaption><br></figure>

<figure class="caption-img"><br>  <img src="/images/web-extension/bottom-panel.png" alt="BottomPanel"><br>  <figcaption><strong><em>BottomPanel</em></strong> <em>Affiche un cadre (ou panel) en bas du site visité</em></figcaption><br></figure>

<p>Mais là vous vous dites que la deuxième image ne fait pas référence à une sidebar. Vous vous sentez flouez par l’article. C’est normal. Lancé dans mon élan, j’ai prévu l’implémentation d’un deuxième panel: une devbar. Il m’était impossible de résister à la tentation.</p>
<h3 id="Etude-des-besoins-et-problemes-a-resoudre"><a href="#Etude-des-besoins-et-problemes-a-resoudre" class="headerlink" title="Etude des besoins et problèmes à résoudre"></a>Etude des besoins et problèmes à résoudre</h3><p>Le projet laisse le choix à l’utilisateur de naviguer entre les panels. Il doit pouvoir passer d’un type de panel à un autre dynamiquement sans avoir à relancer un build ou de recharger la page. Ces panels devront aussi être redimensionnables.</p>
<p>De ce constat, je suis parti sur un système de scène qui va s’atteler à la gestion du rendu des différents panels sélectionnables. Un peu à la React, la scène ainsi que les panels seront vues comme des composants avec une méthode de rendu et de clean. La scène s’occupera d’appeler leurs méthodes réciproques au bon moment.</p>
<p>Les panels seront injectés en position <code>fixed</code>. Le problème principal sera donc de repositionner tous les éléments du site qui arriveront derrière ce panel.</p>
<p>Dans le cas d’une sidebar, l’approche qui parrait la plus évidente est d’ajouter une transformation en translateX sur <code>&lt;html&gt;</code> d’un montant résultant de la dimension du panel. Vous pouvez essayer… ca marche… à première vue. En faite, tous les éléments en position <code>fixed</code> seront correctement repositionnés mais leur fixation ne fonctionnera plus (ils ne suivront plus le scroll). On optera plutôt pour un <code>margin-left</code> et on parcourera le dom pour déplacer tous les éléments <code>fixed</code> à la main. Un autre étape à ne pas oublier est d’ajouter la position <code>relative</code> à <code>body</code> pour les éléments <code>absolute</code>.</p>
<p>Dans le cas d’une devbar, c’est plus simple. Il nous suffit d’ajouter un padding à <code>html</code> du même montant que la dimension du panel.</p>
<h3 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h3><p>Par défaut un Content-Script d’une Web extension s’exécute en mode <code>document_idle</code>. Dans notre cas, ce n’est pas acceptable car l’on veut s’assurer que la sidebar soit affiché dès lors que la page s’ouvre, avant même que son contenu soit chargé. Pour cela, on utilisera le mode <code>document_start</code> dans notre manifest. Il faudra prendre en compte qu’au moment où le script s’executera il n’aura accès qu’a <code>&lt;html&gt;</code> à travers <code>document.documentElement</code>. L’injection du panel se fera donc dans <code>&lt;html&gt;</code> et non pas dans <code>&lt;body&gt;</code> qui lui sera accessible qu’après avoir reçu l’event <code>DOMContentLoaded</code>.</p>
<figure class="highlight javascript"><figcaption><span>manifest.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="string">"content_scripts"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"run_at"</span>: <span class="string">"document_start"</span>,</span><br><span class="line">      <span class="string">"matches"</span>: [<span class="string">"&lt;all_urls&gt;"</span>],</span><br><span class="line">      <span class="string">"js"</span>: [<span class="string">"contentScript.js"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<h3 id="Realisation"><a href="#Realisation" class="headerlink" title="Réalisation"></a>Réalisation</h3><p>Tout d’abord, on va s’attarder sur notre Scene. Comme dit précédemment, elle gère la création des panels, leurs rendus et leurs redimensionnements. Les commentaires sont là pour expliquer le procédé.</p>
<figure class="highlight javascript"><figcaption><span>PanelScene.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> interact <span class="keyword">from</span> <span class="string">'interactjs'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createElement, setStyles &#125; <span class="keyword">from</span> <span class="string">'../utils/dom'</span>;</span><br><span class="line"><span class="keyword">import</span> Body <span class="keyword">from</span> <span class="string">'../elements/Body'</span>;</span><br><span class="line"><span class="keyword">import</span> SidebarPanel <span class="keyword">from</span> <span class="string">'../panels/SidebarPanel'</span>;</span><br><span class="line"><span class="keyword">import</span> BottomPanel <span class="keyword">from</span> <span class="string">'../panels/BottomPanel'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PanelScene</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(params = &#123;&#125;) &#123;</span><br><span class="line">    <span class="comment">// La scène s'attache sur &lt;html&gt;</span></span><br><span class="line">    <span class="keyword">this</span>.root = <span class="built_in">document</span>.documentElement;</span><br><span class="line">    <span class="comment">// document.body amélioré</span></span><br><span class="line">    <span class="comment">// on lui a ajouté setPosition() pour garder en</span></span><br><span class="line">    <span class="comment">// mémoire la position initial de &lt;body&gt;</span></span><br><span class="line">    <span class="keyword">this</span>.body = Body;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Notre scene (&lt;div&gt;)</span></span><br><span class="line">    <span class="keyword">this</span>.view = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// Notre appli (&lt;iframe&gt;)</span></span><br><span class="line">    <span class="keyword">this</span>.appView = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Le dernier panel utilisé</span></span><br><span class="line">    <span class="keyword">this</span>.previousPanel = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// Le panel courant</span></span><br><span class="line">    <span class="keyword">this</span>.selectedPanel = <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Rend accessible nos panels à l'aide d'un index</span></span><br><span class="line">    <span class="keyword">this</span>.panels = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">    <span class="keyword">this</span>.panels.set(<span class="string">'sidebar'</span>, <span class="keyword">new</span> SidebarPanel(<span class="keyword">this</span>, MIN_SIDEBAR_WIDTH));</span><br><span class="line">    <span class="keyword">this</span>.panels.set(<span class="string">'bottom'</span>, <span class="keyword">new</span> BottomPanel(<span class="keyword">this</span>, MIN_BOTTOM_HEIGHT));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Création de la scene</span></span><br><span class="line">  create() &#123;</span><br><span class="line">    <span class="comment">// Créée une div en bas à gauche de l'écran</span></span><br><span class="line">    <span class="keyword">this</span>.view = createElement(<span class="string">'div'</span>, &#123;</span><br><span class="line">      id: <span class="string">`root-<span class="subst">$&#123;APP_NAME&#125;</span>`</span>,</span><br><span class="line">    &#125;, &#123; <span class="attr">border</span>: <span class="string">'0'</span>, <span class="attr">position</span>: <span class="string">'fixed'</span>, <span class="attr">bottom</span>: <span class="string">'0'</span>, <span class="attr">left</span>: <span class="string">'0'</span>, <span class="attr">zIndex</span>: <span class="string">'9999999'</span>, &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Charge le contenu du panel</span></span><br><span class="line">    <span class="keyword">this</span>.appView = createElement(<span class="string">'iframe'</span>, &#123;</span><br><span class="line">      id: APP_NAME,</span><br><span class="line">      src: chrome.runtime.getURL(<span class="string">'/public/frame.csp.html?extid='</span> + chrome.runtime.id)</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      width: <span class="string">'100%'</span>, <span class="attr">height</span>: <span class="string">'100%'</span>, <span class="attr">border</span>: <span class="string">'0'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// On créée les coins draggable du redimensionnement</span></span><br><span class="line">    <span class="keyword">this</span>.edges = createEdges();</span><br><span class="line">    <span class="built_in">Object</span>.values(<span class="keyword">this</span>.edges).forEach(<span class="function">(<span class="params">edge</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.view.append(edge);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.view.append(<span class="keyword">this</span>.appView);</span><br><span class="line">    <span class="keyword">this</span>.root.append(<span class="keyword">this</span>.view);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Intégre la lib pour redimensionner</span></span><br><span class="line">    <span class="keyword">this</span>.createResizable();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// On refait un rendu pour déplacer tous les éléments</span></span><br><span class="line">    <span class="comment">// fixed et absolute lorsque le style est chargé</span></span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'load'</span>, (event) =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.render();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="comment">// Créée le container si c'est pas déjà fait</span></span><br><span class="line">    <span class="keyword">this</span>.ensureCreate();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// La scène précédente doit supprimer tous les</span></span><br><span class="line">    <span class="comment">// styles qu'elle a injecté</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.previous) &#123;</span><br><span class="line">      <span class="keyword">this</span>.getPanel(<span class="keyword">this</span>.previous).clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Rendu du panel sélectionné</span></span><br><span class="line">    <span class="keyword">this</span>.getPanelSelected().render();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  createResizable() &#123;</span><br><span class="line">    interact(<span class="string">`#<span class="subst">$&#123;<span class="keyword">this</span>.view.id&#125;</span>`</span>)</span><br><span class="line">      .resizable(&#123;</span><br><span class="line">        edges: <span class="keyword">this</span>.edges,</span><br><span class="line">        restrictEdges: &#123;</span><br><span class="line">          outer: <span class="string">'parent'</span>,</span><br><span class="line">          endOnly: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        restrictSize: <span class="keyword">this</span>.getPanelSelected().restrict(),</span><br><span class="line">      &#125;)</span><br><span class="line">      .on(<span class="string">'resizestart'</span>, <span class="keyword">this</span>.resizeStart.bind(<span class="keyword">this</span>))</span><br><span class="line">      .on(<span class="string">'resizeend'</span>, <span class="keyword">this</span>.resizeEnd.bind(<span class="keyword">this</span>))</span><br><span class="line">      .on(<span class="string">'resizemove'</span>, (e) =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.resize(e.rect);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/************************************</span></span><br><span class="line"><span class="comment">   ** Reponse aux redimensionnements **</span></span><br><span class="line"><span class="comment">   ************************************/</span></span><br><span class="line"></span><br><span class="line">  resizeStart() &#123;</span><br><span class="line">    <span class="comment">// On supprime la gestion du curseur sur l'iframe</span></span><br><span class="line">    <span class="comment">// pour éviter qu'il ne prenne le pas sur le redimensionnement</span></span><br><span class="line">    <span class="keyword">this</span>.appView.style.pointerEvents = <span class="string">'none'</span>;</span><br><span class="line">    <span class="keyword">this</span>.getPanelSelected().resizing = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  resizeEnd() &#123;</span><br><span class="line">    <span class="keyword">this</span>.appView.style.pointerEvents = <span class="string">'auto'</span>;</span><br><span class="line">    <span class="keyword">this</span>.getPanelSelected().resizing = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// Nouveau rendu dans le but de déplacer tous les élements fixed et absolute</span></span><br><span class="line">    <span class="keyword">this</span>.render();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  resize(rect) &#123;</span><br><span class="line">    <span class="comment">// Change la dimension du panel</span></span><br><span class="line">    <span class="comment">// Provoque un nouveau rendu</span></span><br><span class="line">    <span class="keyword">this</span>.getPanelSelected().setSize(rect);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**************************</span></span><br><span class="line"><span class="comment">   ** Gestion des panels **</span></span><br><span class="line"><span class="comment">   **************************/</span></span><br><span class="line">  togglePanel() &#123;</span><br><span class="line">    <span class="keyword">const</span> type = (!<span class="keyword">this</span>.selected || <span class="keyword">this</span>.selected == <span class="string">'bottom'</span>) ? <span class="string">'sidebar'</span> : <span class="string">'bottom'</span>;</span><br><span class="line">    <span class="keyword">this</span>.setSelected(type);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getPanel(panel) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.panels.get(panel);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getPanelSelected() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getPanel(<span class="keyword">this</span>.selected);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setSelected(panel) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.selected) &#123;</span><br><span class="line">      <span class="keyword">this</span>.previous = <span class="keyword">this</span>.selected;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.selected = panel;</span><br><span class="line">    <span class="keyword">this</span>.render();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ensureCreate() &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">this</span>.view) &#123;</span><br><span class="line">      <span class="keyword">this</span>.create();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Le changement de panel se fera donc simplement avec <code>setSelected</code> qui s’occupera de déléguer le rendu.</p>
<figure class="highlight javascript"><figcaption><span>contentScript.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> panelScene = <span class="keyword">new</span> PanelScene();</span><br><span class="line"></span><br><span class="line">panelScene.setSelected(<span class="string">'sidebar'</span>);</span><br><span class="line"><span class="comment">// ou ... panelScene.setSelected('bottom');</span></span><br></pre></td></tr></table></figure>
<p>Nous avons plusieurs panels qui partagent tous des méthodes identiques. Déjà, ils doivent avoir un <code>render</code> pour styliser la scène et la page visitée, puis un <code>clear</code> pour effacer ces modifications. L’héritage semble donc tout indiqué dans notre cas.</p>
<figure class="highlight javascript"><figcaption><span>BasePanel.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Tout Panel créée devra hériter de cette classe</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasePanel</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(scene, minSize) &#123;</span><br><span class="line">    <span class="keyword">this</span>.scene = scene;</span><br><span class="line">    <span class="keyword">this</span>.resizing = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.minSize = minSize;</span><br><span class="line">    <span class="keyword">this</span>.currentSize = minSize;</span><br><span class="line">    <span class="comment">// Dimension minimal (utile pour le redimensionnement)</span></span><br><span class="line">    <span class="keyword">this</span>.restrictSize = <span class="keyword">this</span>.restrict();  </span><br><span class="line"></span><br><span class="line">    ensureAbstractMethods(<span class="keyword">this</span>, [</span><br><span class="line">      <span class="string">'restrict'</span>,</span><br><span class="line">      <span class="string">'clear'</span>,</span><br><span class="line">      <span class="string">'render'</span>,</span><br><span class="line">    ]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Je n’évoquerai pas le BottomPanel puisque pratiquement identique à notre Sidebar.</p>
<figure class="highlight javascript"><figcaption><span>SidebarPanel.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> BasePanel <span class="keyword">from</span> <span class="string">'./BasePanel'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; setStyles, getFixedNode &#125; <span class="keyword">from</span> <span class="string">'../utils/dom'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SidebarPanel</span> <span class="keyword">extends</span> <span class="title">BasePanel</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Restriction du dimensionnement par rapport à sa largeur</span></span><br><span class="line">  restrict() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">width</span>: <span class="keyword">this</span>.minSize &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="comment">// Dimensionnement &amp;&amp; styling de la scène</span></span><br><span class="line">    <span class="comment">// Egalement appelé lors du redimensionnement</span></span><br><span class="line">    setStyles(<span class="keyword">this</span>.scene.view, &#123;</span><br><span class="line">      width: <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.currentSize&#125;</span>px`</span>,</span><br><span class="line">      top: <span class="string">'0'</span>,</span><br><span class="line">      height: <span class="string">'auto'</span>,</span><br><span class="line">      border: <span class="string">'O'</span>,</span><br><span class="line">      borderRight: <span class="string">'1px solid rgba(0, 0, 0, 0.04)'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &lt;body&gt; doit être mis en relative pour les éléments absolutes</span></span><br><span class="line">    <span class="keyword">this</span>.scene.body.setPosition(<span class="string">'relative'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.scene.root.style.marginLeft = <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.currentSize&#125;</span>px`</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Déplace les élements fixed seulement lorsque</span></span><br><span class="line">    <span class="comment">// l'on ne redimensionne pas pour des raisons de perf</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">this</span>.resizing) &#123;</span><br><span class="line">      <span class="keyword">this</span>.moveFixedNode();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Efface les modifications</span></span><br><span class="line">  clear() &#123;</span><br><span class="line">    <span class="keyword">this</span>.scene.root.style.marginLeft = <span class="string">'0'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.moveFixedNode(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">this</span>.scene.body.restorePosition();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Déplace tous les éléments fixed</span></span><br><span class="line">  moveFixedNode(forceSize) &#123;</span><br><span class="line">    <span class="keyword">const</span> size = (<span class="keyword">typeof</span> forceSize === <span class="string">'undefined'</span>) ? <span class="keyword">this</span>.currentSize : forceSize;</span><br><span class="line">    <span class="keyword">const</span> nodes = getFixedNode(<span class="function">(<span class="params">node, style</span>) =&gt;</span> node !== <span class="keyword">this</span>.scene.view);</span><br><span class="line"></span><br><span class="line">    nodes.forEach(<span class="function"><span class="params">node</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(!node.getAttribute(<span class="string">'data-ori-x'</span>)) &#123;</span><br><span class="line">        <span class="keyword">const</span> style = <span class="built_in">window</span>.getComputedStyle(node);</span><br><span class="line">        node.setAttribute(<span class="string">'data-ori-x'</span>, <span class="built_in">parseInt</span>(style.left, <span class="number">10</span>) || <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> oriX = <span class="built_in">parseInt</span>(node.getAttribute(<span class="string">'data-ori-x'</span>), <span class="number">10</span>);</span><br><span class="line">      node.style.left = <span class="string">`<span class="subst">$&#123;oriX + size&#125;</span>px`</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Determine currentSize à partir du rectangle récupéré</span></span><br><span class="line">  <span class="comment">// de l'event de redimensionnement</span></span><br><span class="line">  setSize(rect) &#123;</span><br><span class="line">    <span class="keyword">this</span>.currentSize = <span class="built_in">parseInt</span>(rect.width, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">this</span>.render();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>L’intégralité du code peut être retrouvé <a href="https://github.com/karlito40/fofo/tree/ac214cbd08a46944dd97a013da913e7ee7da64a4/fofo-web-ext" target="_blank" rel="noopener">ici</a>. Ce lien faisant référence à un commit en particulier, pensez à regarder la branche master pour voir si j’ai pas trouvé une meilleur façon de faire entre temps.</p>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Javascript/">
                #Javascript
              </a>
            
              <a href="/tags/WebExtension/">
                #WebExtension
              </a>
            
          </div>
        

        

        
      </div>
    
  </div>



  
    
  

          </div>

          
        </div>

        
<div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>

<div id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    
      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-overview" data-target="site-overview">
          Ensemble
        </li>
        <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc">
          Table Des Matières
        </li>
      </ul>
    

    <div class="site-overview">
      <div class="site-author motion-element">
        <img class="site-author-image" src="/images/default_avatar.jpg" alt="Karlito" />
        <p class="site-author-name">Karlito</p>
      </div>
      <p class="site-description motion-element">Node et Javascript en pratique: tutoriels, exemple et experimentation.</p>
      <div class="site-state motion-element">
        <div class="site-state-item site-state-posts">
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">articles</span>
        </div>
        <div class="site-state-item site-state-tags">
            <span class="site-state-item-count">9</span>
            <span class="site-state-item-name">tags</span>
        </div>
        <div class="site-state-item site-state-pages">
            <span class="site-state-item-count">2</span>
            <span class="site-state-item-name">pages</span>
        </div>
      </div>

      

      <div class="social-info motion-element">
        
          
            <span class="soclial-item">
              <a href="https://github.com/karlito40">GITHUB</a>
            </span>
          
            <span class="soclial-item">
              <a href="https://twitter.com/karlito40">TWITTER</a>
            </span>
          
        
      </div>

    </div>

    
      <div class="post-toc sidebar-panel-active">
        <ol class="motion-element"><li class="motion-element-item motion-element-level-3"><a class="motion-element-link" href="#Etude-des-besoins-et-problemes-a-resoudre"><span class="motion-element-number">1.</span> <span class="motion-element-text">Etude des besoins et problèmes à résoudre</span></a></li><li class="motion-element-item motion-element-level-3"><a class="motion-element-link" href="#Performance"><span class="motion-element-number">2.</span> <span class="motion-element-text">Performance</span></a></li><li class="motion-element-item motion-element-level-3"><a class="motion-element-link" href="#Realisation"><span class="motion-element-number">3.</span> <span class="motion-element-text">Réalisation</span></a></li><li class="motion-element-item motion-element-level-3"><a class="motion-element-link" href="#Conclusion"><span class="motion-element-number">4.</span> <span class="motion-element-text">Conclusion</span></a></li></ol>
      </div>
    
  </div>
</div>


      </div>
    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp; 
  2018
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">Karlito</span>
</div>

<!--
<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Thème - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT</a>
</div>
-->





      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/dist/jquery.min.js?v=0.3.0rc1"></script>
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      $(".fancybox").fancybox();
    });
  </script>



  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  

  <script type="text/javascript">
    $(document).ready(function () {
      var body = $('body');
      var isSidebarVisible = false;
      var sidebarToggle = $('.sidebar-toggle');
      var sidebarToggleLine1st = $('.sidebar-toggle-line-first')
      var sidebarToggleLine2nd = $('.sidebar-toggle-line-middle');
      var sidebarToggleLine3rd = $('.sidebar-toggle-line-last');
      var sidebar = $('.sidebar');

      var sidebarToogleLineStatusInit = {width: '100%', opacity: 1, left: 0, rotateZ: 0, top: 0};

      var sidebarToggleLine1stStatusInit = sidebarToogleLineStatusInit;
      var sidebarToggleLine1stStatusArrow = {width: '50%', rotateZ: '-45deg', top: '2px'};
      var sidebarToogleLine1stStatusClose = {width: '100%', rotateZ: '-45deg', top: '5px'};

      var sidebarToggleLine2ndStatusInit = sidebarToogleLineStatusInit;
      var sidebarToggleLine2ndStatusArrow = {width: '90%'};
      var sidebarToogleLine2ndStatusClose = {opacity: 0};

      var sidebarToggleLine3rdStatusInit = sidebarToogleLineStatusInit;
      var sidebarToggleLine3rdStatusArrow = {width: '50%', rotateZ: '45deg', top: '-2px'};
      var sidebarToogleLine3rdStatusClose = {width: '100%', rotateZ: '45deg', top: '-5px'};

      sidebatToggleMotion();
      postsListMotion();
      backToTopMotion();

      function sidebarContentMotion () {
        $('.sidebar .motion-element').velocity(
          'transition.slideRightIn',
          {stagger: 50, drag: true}
        );
      }


      function backToTopMotion () {
        var b2top = $('.back-to-top');
        b2top.on('click', function () {
          body.velocity('scroll');
        });
      }

      function sidebarShowMotion () {
        var sidebarDisplayDuration = 300;
        var sidebarWidth = '320px';

        sidebarToggleLine1st.velocity(sidebarToogleLine1stStatusClose);
        sidebarToggleLine2nd.velocity(sidebarToogleLine2ndStatusClose);
        sidebarToggleLine3rd.velocity(sidebarToogleLine3rdStatusClose);

        sidebar.velocity({width: sidebarWidth}, sidebarDisplayDuration);
        isDesktop() && body.velocity({paddingRight: sidebarWidth}, sidebarDisplayDuration);
        sidebarContentMotion();
      }

      function sidebarHideMotion () {
        isDesktop() && body.velocity({paddingRight: 0});
        sidebar.velocity('reverse');

        sidebarToggleLine1st.velocity(sidebarToggleLine1stStatusInit);
        sidebarToggleLine2nd.velocity(sidebarToggleLine2ndStatusInit);
        sidebarToggleLine3rd.velocity(sidebarToggleLine3rdStatusInit);
      };

      function postsListMotion () {
        $('.post').velocity('transition.slideDownIn', {stagger: 300, drag: true});
      }

      function sidebatToggleMotion () {
        sidebarToggle.on('click', function () {
          isSidebarVisible ? sidebarHideMotion() : sidebarShowMotion();
          isSidebarVisible = !isSidebarVisible;
        });
        sidebarToggle.hover(function () {
          if (isSidebarVisible) {return}
          sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusArrow);
          sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusArrow);
          sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusArrow);
        }, function () {
          if (isSidebarVisible) {return}
          sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusInit);
          sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusInit);
          sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusInit);
        });
      }

      function isDesktop () {
        return screen.width > 991;
      }

      function isTablet () {
        return screen.width < 992 && screen.width > 767;
      }

      function isMobile () {
        return screen.width < 767;
      }
    });
  </script>

  

  
  
    <script type="text/javascript">
      $(document).ready(function () {
        var html = $('html');

        $('.sidebar-nav li').on('click', function () {
          var item = $(this);
          var activeTabClassName = 'sidebar-nav-active';
          var activePanelClassName = 'sidebar-panel-active';
          if (item.hasClass(activeTabClassName)) {
            return;
          }

          var currentTarget = $('.' + activePanelClassName);
          var target = $('.' + item.data('target'));

          $.Velocity
            .animate(currentTarget, 'transition.slideUpOut', 200)
            .then(function () {
              target
              .velocity('stop')
              .velocity('transition.slideDownIn', 200)
              .addClass(activePanelClassName);
            });

          item.siblings().removeClass(activeTabClassName);
          item.addClass(activeTabClassName);
        });

        $('.post-toc a').on('click', function (e) {
          e.preventDefault();
          var offset = $(this.getAttribute('href')).offset().top;
          html.velocity('stop').velocity('scroll', {
            offset: offset  + 'px',
            mobileHA: false
          });
        });
      });
    </script>
  



  
  

  


  
</body>
</html>
