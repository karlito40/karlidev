<!doctype html>
<html class="theme-next use-motion">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>




  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.3.0rc1"/>


    <meta name="description" content="Node et Javascript en pratique: tutoriels, exemple et experimentation." />



    <meta name="keywords" content="Javascript, Node, Mongo, PHP, Go, Git, Benchmark, Developpeur web" />





    <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.3.0rc1" />


<style>
body{
	word-spacing:2px;
}

</style>


  <title> Journal de bord d'un développeur </title>
</head>

<body>
  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
    <a href="/" class="brand">
        <span class="logo">
          <i class="icon-logo"></i>
        </span>
        <span class="site-title">Karlidev</span>
    </a>
</h1>


  <ul id="menu" class="menu">
    
      
      <li class="menu-item menu-item-home">
        <a href="/">
          <i class="menu-item-icon icon-home"></i> <br />
          Accueil
        </a>
      </li>
    
      
      <li class="menu-item menu-item-archives">
        <a href="/archives">
          <i class="menu-item-icon icon-archives"></i> <br />
          Archives
        </a>
      </li>
    
      
      <li class="menu-item menu-item-tags">
        <a href="/tags">
          <i class="menu-item-icon icon-tags"></i> <br />
          Tags
        </a>
      </li>
    
  </ul>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
            
          

          <div id="posts" class="posts-expand">
            
  
    

  <div class="post post-type-normal ">
    <div class="post-header">
      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2018/11/05/docker-et-eb/">
                Déployer docker avec Elastic Beanstalk
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posté le 05/11/2018
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <p>Avant le déploiement, nos images images docker doivent être publié pour qu’Elastic Beanstalk puisse y accéder. Pour ce faire, on utilisera les commandes suivantes.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t my-image . </span><br><span class="line">$ docker tag my-image $ORGANISATION/my-image</span><br><span class="line">$ docker push $ORGANISATION/my-image</span><br></pre></td></tr></table></figure>
<h2 id="A-partir-d’un-container-simple"><a href="#A-partir-d’un-container-simple" class="headerlink" title="A partir d’un container simple"></a>A partir d’un container simple</h2><ol>
<li><p><code>eb init</code></p>
<p>Selectionner la plateforme <code>7) Docker</code></p>
</li>
<li><p><code>eb create $ENV_NAME</code>  <em>(exemple: api-prod)</em></p>
</li>
<li><p>Créez un fichier <code>Dockerrun.aws.json</code> <code>version 1</code> pour expliciter la configuration de docker</p>
</li>
</ol>
<figure class="highlight javascript"><figcaption><span>Dockerrun.aws.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// exemple</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"AWSEBDockerrunVersion"</span>: <span class="string">"1"</span>,</span><br><span class="line">  <span class="string">"Image"</span>: &#123;</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"karlito40/laravel"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"Ports"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"ContainerPort"</span>: <span class="string">"80"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"ContainerPort"</span>: <span class="string">"443"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"Volumes"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"HostDirectory"</span>: <span class="string">"/var/app/current"</span>,</span><br><span class="line">      <span class="string">"ContainerDirectory"</span>: <span class="string">"/var/www/laravel"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"HostDirectory"</span>: <span class="string">"/var/app/current/docker/nginx/fofo-api.prod.conf"</span>,</span><br><span class="line">      <span class="string">"ContainerDirectory"</span>: <span class="string">"/etc/nginx/conf.d/default.conf"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"HostDirectory"</span>: <span class="string">"/var/app/current/docker/nginx/ssl"</span>,</span><br><span class="line">      <span class="string">"ContainerDirectory"</span>: <span class="string">"/etc/nginx/ssl"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"Logging"</span>: <span class="string">"/var/log/nginx"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li><code>eb deploy</code></li>
</ol>
<h2 id="A-partir-d’une-composition"><a href="#A-partir-d’une-composition" class="headerlink" title="A partir d’une composition"></a>A partir d’une composition</h2><ol>
<li><p><code>eb init</code></p>
<p>Selectionner la plateforme <code>8) Multi-container Docker</code></p>
</li>
<li><p><code>eb create $ENV_NAME</code>  <em>(exemple: api-prod)</em></p>
</li>
<li><p>Créez un fichier <code>Dockerrun.aws.json</code> <code>version 2</code> pour expliciter la configuration de docker</p>
<p>Le procédé peut être simplifié à l’aide de l’image docker micahhausler/container-transform.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat docker-compose.yml | docker run --rm -i micahhausler/container-transform &gt; Dockerrun.aws.json</span><br></pre></td></tr></table></figure>
<p>Il faudra cependant veiller à corriger le contenu généré. L’id de version (ici 2) doit être rajouté et, dans certains cas, certaines erreurs devront être résolues.</p>
</li>
</ol>
<ol start="4">
<li><code>eb deploy</code></li>
</ol>
<h2 id="Inspection-du-container"><a href="#Inspection-du-container" class="headerlink" title="Inspection du container"></a>Inspection du container</h2><ol>
<li><code>eb ssh</code></li>
</ol>
<ul>
<li><p>Les logs sont accessibles sous <code>/var/lib/docker/containers/&lt;container id&gt;/&lt;container id&gt;-json.log</code></p>
</li>
<li><p>La connexion au container se fait à l’aide de <code>docker exec -it &lt;mycontainer&gt; bash</code> (quand bash est installé)</p>
</li>
</ul>
<h2 id="Custom-domain"><a href="#Custom-domain" class="headerlink" title="Custom domain"></a>Custom domain</h2><ul>
<li><p>Coté nom de domaine</p>
<ol>
<li>Allez sur le dashboard de votre nom de domaine. </li>
<li>Ajoutez lui un sous domaine. </li>
<li>Configurez ses DNS en lui attribuant un CNAME pointant vers l’url de l’environnement ELB.</li>
</ol>
</li>
<li><p>Coté AWS</p>
<ol>
<li>Allez dans le service “Certificate Manager”.</li>
<li>Cliquez sur “Demander un certificat” puis renseignez comme nom de domaine <code>*.mon-domaine.com</code></li>
<li>Validez la demande de certificat par mail.</li>
<li>Retournez dans le service elastic beanstalk à la section configuration. </li>
<li>Selectionnez le Load Balancer.</li>
<li>Ajoutez lui un listener <code>HTTPS 443</code> pointant vers <code>HTTP 80</code> avec le certificat précédemment créée.</li>
</ol>
</li>
</ul>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/AWS/">
                #AWS
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">
      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2018/09/29/web-extension-communication-entre-scripts/">
                Web extension, communication entre scripts
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posté le 29/09/2018
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <p>Précédemment, nous avons vu comment “hacker” un site web pour y intégrer notre petite application. Maintenant, il nous reste plus qu’à implémenter la communication entre les différents scripts que contiennent une WebExtension.</p>
<p>Une WebExtension se compose de deux scripts.</p>
<ul>
<li><strong>content_scripts</strong> qui s’occupe de la page consultée.</li>
<li><strong>background</strong> qui écoute en tache de fond du navigateur.</li>
</ul>
<p>Deux méthodes différentes existent pour dialoguer avec eux.</p>
<ul>
<li><code>chrome.tabs.sendMessage</code> appelle content_script.</li>
<li><code>chrome.runtime.sendMessage</code> appelle background.</li>
</ul>
<p>Les scripts répondent à ces messages à l’aide de <code>chrome.runtime.onMessage</code>.</p>
<p>Ajourd’hui nous cherchons à simplifier le système de routing des messages. Mon idée, aussi valable dans d’autres circonstances (dialogue entre microservices, api, …), est de permettre à un script d’exposer ses fonctions aux  autres. Les différents scripts devront être capable d’appeler directement ces fonctions en utilisant leurs signatures.</p>
<p>Bon ok, je suis pas clair. Ce que je veux faire, c’est ca:</p>
<figure class="highlight javascript"><figcaption><span>background.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">maFonction</span>(<span class="params">p1, p2</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;<span class="attr">done</span>: yes&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">uneFonctionAsync</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> resolve(&#123;<span class="attr">done</span>: yes&#125;), <span class="number">200</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... + d'autres fonctions ...</span></span><br></pre></td></tr></table></figure>
<p>Le script en background expose ses fonctions, puis le content-script les consomment sans avoir à s’occuper de <code>sendMessage</code>.</p>
<figure class="highlight javascript"><figcaption><span>content-script.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> res1 = <span class="keyword">await</span> background.maFonction(<span class="string">'lorem'</span>, <span class="string">'ipsum'</span>);</span><br><span class="line"><span class="keyword">const</span> res2 = <span class="keyword">await</span> background.uneFonctionAsync();</span><br></pre></td></tr></table></figure>
<p>Bien sûr background.js pourra lui aussi appeler des fonctions de content-script.js s’il en expose.</p>
<p>Avant de pouvoir implémenter ca, on doit d’abord se poser la question du routing. J’ai opté pour l’utilisation d’un objet contenant le nom de la commande/fonction à utiliser ainsi que son tableau d’arguments à rattacher.</p>
<figure class="highlight javascript"><figcaption><span>message.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createAction</span>(<span class="params">cmd, ...args</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; cmd, args &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Envoie du message</span></span><br><span class="line"><span class="keyword">const</span> action = createAction(<span class="string">'maFonction'</span>, [<span class="string">'lorem'</span>, <span class="string">'ipsum'</span>]);</span><br><span class="line">chrome.runtime.sendMessage(action, <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;&#125;)</span><br></pre></td></tr></table></figure>
<p>La table de routage se fait à l’aide d’une “HashMap” comprenant en clé le nom de la fonction exposée. On profite d’<code>import * as commands from &#39;./fonctions-a-exposer&#39;</code> pour générer automatiquement l’objet.</p>
<figure class="highlight javascript"><figcaption><span>message.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Récupère la table de routage</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> commands <span class="keyword">from</span> <span class="string">'./fonctions-a-exposer'</span>;</span><br><span class="line"><span class="comment">// Ecoute les messages en provenances des autres sources</span></span><br><span class="line">chrome.runtime.onMessage.addListener(listener(&#123;commands&#125;));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">listener</span>(<span class="params">options = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> commands = options.commands || &#123;&#125;;</span><br><span class="line">  <span class="comment">// Attention les extensions ne supportent pas await dans ce callback,</span></span><br><span class="line">  <span class="comment">// du coup on utilisera le bon vieux then</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">onMessage</span>(<span class="params">request, sender, sendResponse</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> response = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// request contient l'action "maFonction" de tout à l'heure</span></span><br><span class="line">    <span class="comment">// avec comme args ['lorem', 'ipsum']</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// commands contient la table de routage</span></span><br><span class="line">    <span class="comment">// si commands.maFonction existe, on l'execute.</span></span><br><span class="line">    <span class="keyword">if</span>(request.cmd &amp;&amp; commands[request.cmd]) &#123;</span><br><span class="line">      response = commands[request.cmd](...request.args, sender);</span><br><span class="line">      <span class="comment">// On en profite pour gérer les reponses asynchrones</span></span><br><span class="line">      <span class="keyword">if</span>(response <span class="keyword">instanceof</span> <span class="built_in">Promise</span>) &#123;</span><br><span class="line">        response.then(sendResponse);</span><br><span class="line">        <span class="comment">// Dans le cas d'une réponse asynchrone</span></span><br><span class="line">        <span class="comment">// on doit retourner true</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sendResponse(response);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>On est dorénavant capable d’éxécuter une fonction à distance. Par contre, le format ne convient pas à notre idée de départ. On doit toujours passer par <code>createAction</code> ce qui rend l’utilisation pénible.</p>
<p>Pour remédier à cela, on va créer une facade qui s’occupera d’exécuter <code>sendMessage</code> à notre place. ES2015 intègre une nouvelle classe, <code>Proxy</code>, qui convient parfaitement à cette description. Elle nous permet de placer des “écouteurs” sur un objet donné. Ces écouteurs seront appelés dès lors qu’une propriété est demandé ou modifié.</p>
<p>Tout d’abord, amusons nous à créer le Proxy d’appel au background.</p>
<figure class="highlight javascript"><figcaption><span>message.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Tous les accès aux propriétés de serviceBackground</span></span><br><span class="line"><span class="comment">// renverrons vers sendMessage avec comme commande le nom</span></span><br><span class="line"><span class="comment">// de la propriété appeler</span></span><br><span class="line"><span class="keyword">const</span> serviceBackground = <span class="keyword">new</span> <span class="built_in">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line">  get(obj, cmd) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> sendMessage(createAction(cmd, ...args));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// on peut désormais appeler sendMessage comme suit</span></span><br><span class="line"><span class="comment">// serviceBackground.maFonction('lorem', 'ipsum')</span></span><br></pre></td></tr></table></figure>
<p>Un peu plus compliqué, l’envoie d’un message à content_script nécessite de récupérer l’identifiant de l’onglet dans lequel celui ci évolue. Notre objectif est de coupler cette récupération à l’envoie du message de sorte à pouvoir faire  <code>service.content.get(tabId).maFonction()</code></p>
<figure class="highlight javascript"><figcaption><span>message.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> serviceContent = &#123;</span><br><span class="line">  <span class="comment">// Pour envoyer sur l'onglet courant</span></span><br><span class="line">  current() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line">      get(obj, cmd) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">async</span> (...args) =&gt; &#123;</span><br><span class="line">          <span class="keyword">const</span> tab = <span class="keyword">await</span> getCurrentTab();</span><br><span class="line">          <span class="keyword">return</span> sendMessage(tabId, createAction(cmd, ...args));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// Pour envoyer sur un onglet spécifique</span></span><br><span class="line">  get(tabId) &#123;</span><br><span class="line">    <span class="comment">// Similaire à serviceBackground</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line">      get(obj, cmd) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> sendMessage(tabId, createAction(cmd, ...args));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>On oublie pas d’exporter nos services.</p>
<figure class="highlight javascript"><figcaption><span>message.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> service = &#123;</span><br><span class="line">  content: serviceContent,</span><br><span class="line">  background: serviceBackground,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Et voila ! Nos scripts peuvent désormais communiquer facilement entre eux.</p>
<figure class="highlight javascript"><figcaption><span>exemple.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;service&#125; <span class="keyword">from</span> <span class="string">'message'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pour appeler content_script</span></span><br><span class="line"><span class="keyword">const</span> res = <span class="keyword">await</span> service.content.get(tabId).uneCommandeExpose(<span class="string">'lorem'</span>, <span class="string">'ipsum'</span>);</span><br><span class="line"><span class="keyword">const</span> res2 = <span class="keyword">await</span> service.content.current().uneCommandeExpose(<span class="string">'lorem'</span>, <span class="string">'ipsum'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pour appeler background</span></span><br><span class="line"><span class="keyword">const</span> res3 = <span class="keyword">await</span> service.background.uneCommandeExpose(<span class="string">'lorem'</span>, <span class="string">'ipsum'</span>);</span><br></pre></td></tr></table></figure>
<p>Vous n’avez pas tout suivi ? Il vous manque une partie de l’implémentation ? N’ayez crainte, le code est disponible <a href="https://github.com/karlito40/fofo/blob/8c9ddac1b15539496669052887f599ae454ac71f/fofo-web-ext/src/shared/ipc.js" target="_blank" rel="noopener">ici</a>. Vous y retrouverez notamment l’implémentation de <code>sendMessage</code>et de <code>getCurrentTab</code>.</p>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Javascript/">
                #Javascript
              </a>
            
              <a href="/tags/WebExtension/">
                #WebExtension
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">
      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2018/09/22/web-extension-creer-une-sidebar/">
                Web extension, créer une sidebar
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posté le 22/09/2018
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <p>Dans l’épisode précédent, nous avons étudié l’<a href="/2018/09/16/web-extension-injecter-une-iframe">injection d’iframe</a> dans une Web extension. Nous savons désormais qu’il est possible d’intégrer du contenu à un site web en limitant l’altération de son style et sa structure.</p>
<p>Mon envie maintenant est de me servir de ce que nous avons appris pour créer un panel ajustable et paramétrable. Comme des images sont plus parlantes que des mots, je vous présente le prototype issue de cet article.</p>
<figure class="caption-img"><br>  <img src="/images/web-extension/sidebar-panel.png" alt="SidebarPanel"><br>  <figcaption><strong><em>SidebarPanel</em></strong> <em>Affiche un cadre (ou panel) sur le coté gauche du site visité</em></figcaption><br></figure>

<figure class="caption-img"><br>  <img src="/images/web-extension/bottom-panel.png" alt="BottomPanel"><br>  <figcaption><strong><em>BottomPanel</em></strong> <em>Affiche un cadre (ou panel) en bas du site visité</em></figcaption><br></figure>

<p>Si vous vous sentez floué par l’article à la vue de la deuxième image, c’est normal. Lancé dans mon élan, j’ai ajouté un deuxième panel: une devbar. Il m’était impossible de résister à la tentation.</p>
<h3 id="Etude-des-besoins-et-problemes-a-resoudre"><a href="#Etude-des-besoins-et-problemes-a-resoudre" class="headerlink" title="Etude des besoins et problèmes à résoudre"></a>Etude des besoins et problèmes à résoudre</h3><p>Le projet laisse le choix à l’utilisateur de naviguer entre les panels. Il doit pouvoir passer d’un type de panel à un autre dynamiquement sans avoir à relancer un build ou de recharger la page. Ces panels devront aussi être redimensionnables.</p>
<p>De ce constat, je suis parti sur un système de scène qui va s’atteler à la gestion du rendu des différents panels sélectionnables. Un peu à la React, la scène ainsi que les panels seront vues comme des composants avec une méthode de rendu et de clean. La scène s’occupera d’appeler leurs méthodes réciproques au bon moment.</p>
<p>Les panels seront injectés en position <code>fixed</code>. Le problème principal sera donc de repositionner tous les éléments du site qui arriveront derrière ce panel.</p>
<p>Dans le cas d’une sidebar, l’approche qui parrait la plus évidente est d’ajouter une transformation en translateX sur <code>&lt;html&gt;</code> d’un montant résultant de la dimension du panel. Vous pouvez essayer… ca marche… à première vue. En faite, tous les éléments en position <code>fixed</code> seront correctement repositionnés mais leur fixation ne fonctionnera plus (ils ne suivront plus le scroll). On optera plutôt pour un <code>margin-left</code> et on parcourera le dom pour déplacer tous les éléments <code>fixed</code> à la main. Un autre étape à ne pas oublier est d’ajouter la position <code>relative</code> à <code>body</code> pour les éléments <code>absolute</code>.</p>
<p>Dans le cas d’une devbar, c’est plus simple. Il nous suffit d’ajouter un padding à <code>html</code> du même montant que la dimension du panel.</p>
<h3 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h3><p>Par défaut un Content-Script d’une Web extension s’exécute en mode <code>document_idle</code>. Dans notre cas, ce n’est pas acceptable car l’on veut s’assurer que la sidebar soit affichée dès lors que la page s’ouvre, avant même que son contenu soit chargé. Pour cela, on utilisera le mode <code>document_start</code> dans notre manifest. Il faudra prendre en compte qu’au moment où le script s’executera il n’aura accès qu’a <code>&lt;html&gt;</code> à travers <code>document.documentElement</code>. L’injection du panel se fera donc dans <code>&lt;html&gt;</code> et non pas dans <code>&lt;body&gt;</code> qui lui sera accessible qu’après avoir reçu l’event <code>DOMContentLoaded</code>.</p>
<figure class="highlight javascript"><figcaption><span>manifest.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="string">"content_scripts"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"run_at"</span>: <span class="string">"document_start"</span>,</span><br><span class="line">      <span class="string">"matches"</span>: [<span class="string">"&lt;all_urls&gt;"</span>],</span><br><span class="line">      <span class="string">"js"</span>: [<span class="string">"contentScript.js"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<h3 id="Realisation"><a href="#Realisation" class="headerlink" title="Réalisation"></a>Réalisation</h3><p>Tout d’abord, on va s’attarder sur notre Scene. Comme dit précédemment, elle gère la création des panels, leurs rendus et leurs redimensionnements. Les commentaires sont là pour expliquer le procédé.</p>
<figure class="highlight javascript"><figcaption><span>PanelScene.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> interact <span class="keyword">from</span> <span class="string">'interactjs'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createElement, setStyles &#125; <span class="keyword">from</span> <span class="string">'../utils/dom'</span>;</span><br><span class="line"><span class="keyword">import</span> Body <span class="keyword">from</span> <span class="string">'../elements/Body'</span>;</span><br><span class="line"><span class="keyword">import</span> SidebarPanel <span class="keyword">from</span> <span class="string">'../panels/SidebarPanel'</span>;</span><br><span class="line"><span class="keyword">import</span> BottomPanel <span class="keyword">from</span> <span class="string">'../panels/BottomPanel'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PanelScene</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(params = &#123;&#125;) &#123;</span><br><span class="line">    <span class="comment">// La scène s'attache sur &lt;html&gt;</span></span><br><span class="line">    <span class="keyword">this</span>.root = <span class="built_in">document</span>.documentElement;</span><br><span class="line">    <span class="comment">// document.body amélioré</span></span><br><span class="line">    <span class="comment">// on lui a ajouté setPosition() pour garder en</span></span><br><span class="line">    <span class="comment">// mémoire la position initial de &lt;body&gt;</span></span><br><span class="line">    <span class="keyword">this</span>.body = Body;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Notre scene (&lt;div&gt;)</span></span><br><span class="line">    <span class="keyword">this</span>.view = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// Notre appli (&lt;iframe&gt;)</span></span><br><span class="line">    <span class="keyword">this</span>.appView = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Le dernier panel utilisé</span></span><br><span class="line">    <span class="keyword">this</span>.previousPanel = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// Le panel courant</span></span><br><span class="line">    <span class="keyword">this</span>.selectedPanel = <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Rend accessible nos panels à l'aide d'un index</span></span><br><span class="line">    <span class="keyword">this</span>.panels = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">    <span class="keyword">this</span>.panels.set(<span class="string">'sidebar'</span>, <span class="keyword">new</span> SidebarPanel(<span class="keyword">this</span>, MIN_SIDEBAR_WIDTH));</span><br><span class="line">    <span class="keyword">this</span>.panels.set(<span class="string">'bottom'</span>, <span class="keyword">new</span> BottomPanel(<span class="keyword">this</span>, MIN_BOTTOM_HEIGHT));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Création de la scene</span></span><br><span class="line">  create() &#123;</span><br><span class="line">    <span class="comment">// Créée une div en bas à gauche de l'écran</span></span><br><span class="line">    <span class="keyword">this</span>.view = createElement(<span class="string">'div'</span>, &#123;</span><br><span class="line">      id: <span class="string">`root-<span class="subst">$&#123;APP_NAME&#125;</span>`</span>,</span><br><span class="line">    &#125;, &#123; <span class="attr">border</span>: <span class="string">'0'</span>, <span class="attr">position</span>: <span class="string">'fixed'</span>, <span class="attr">bottom</span>: <span class="string">'0'</span>, <span class="attr">left</span>: <span class="string">'0'</span>, <span class="attr">zIndex</span>: <span class="string">'9999999'</span>, &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Charge le contenu du panel</span></span><br><span class="line">    <span class="keyword">this</span>.appView = createElement(<span class="string">'iframe'</span>, &#123;</span><br><span class="line">      id: APP_NAME,</span><br><span class="line">      src: chrome.runtime.getURL(<span class="string">'/public/frame.csp.html?extid='</span> + chrome.runtime.id)</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      width: <span class="string">'100%'</span>, <span class="attr">height</span>: <span class="string">'100%'</span>, <span class="attr">border</span>: <span class="string">'0'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// On créée les coins draggable du redimensionnement</span></span><br><span class="line">    <span class="keyword">this</span>.edges = createEdges();</span><br><span class="line">    <span class="built_in">Object</span>.values(<span class="keyword">this</span>.edges).forEach(<span class="function">(<span class="params">edge</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.view.append(edge);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.view.append(<span class="keyword">this</span>.appView);</span><br><span class="line">    <span class="keyword">this</span>.root.append(<span class="keyword">this</span>.view);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Intégre la lib pour redimensionner</span></span><br><span class="line">    <span class="keyword">this</span>.createResizable();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// On refait un rendu pour déplacer tous les éléments</span></span><br><span class="line">    <span class="comment">// fixed et absolute lorsque le style est chargé</span></span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'load'</span>, (event) =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.render();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="comment">// Créée le container si c'est pas déjà fait</span></span><br><span class="line">    <span class="keyword">this</span>.ensureCreate();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// La scène précédente doit supprimer tous les</span></span><br><span class="line">    <span class="comment">// styles qu'elle a injecté</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.previousPanel) &#123;</span><br><span class="line">      <span class="keyword">this</span>.previousPanel.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Rendu du panel sélectionné</span></span><br><span class="line">    <span class="keyword">this</span>.selectedPanel.render();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  createResizable() &#123;</span><br><span class="line">    interact(<span class="string">`#<span class="subst">$&#123;<span class="keyword">this</span>.view.id&#125;</span>`</span>)</span><br><span class="line">      .resizable(&#123;</span><br><span class="line">        edges: <span class="keyword">this</span>.edges,</span><br><span class="line">        restrictEdges: &#123;</span><br><span class="line">          outer: <span class="string">'parent'</span>,</span><br><span class="line">          endOnly: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        restrictSize: <span class="keyword">this</span>.selectedPanel.restrict(),</span><br><span class="line">      &#125;)</span><br><span class="line">      .on(<span class="string">'resizestart'</span>, <span class="keyword">this</span>.resizeStart.bind(<span class="keyword">this</span>))</span><br><span class="line">      .on(<span class="string">'resizeend'</span>, <span class="keyword">this</span>.resizeEnd.bind(<span class="keyword">this</span>))</span><br><span class="line">      .on(<span class="string">'resizemove'</span>, (e) =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.resize(e.rect);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/************************************</span></span><br><span class="line"><span class="comment">   ** Reponse aux redimensionnements **</span></span><br><span class="line"><span class="comment">   ************************************/</span></span><br><span class="line"></span><br><span class="line">  resizeStart() &#123;</span><br><span class="line">    <span class="comment">// On supprime la gestion du curseur sur l'iframe</span></span><br><span class="line">    <span class="comment">// pour éviter qu'il ne prenne le pas sur le redimensionnement</span></span><br><span class="line">    <span class="keyword">this</span>.appView.style.pointerEvents = <span class="string">'none'</span>;</span><br><span class="line">    <span class="keyword">this</span>.selectedPanel.resizing = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  resizeEnd() &#123;</span><br><span class="line">    <span class="keyword">this</span>.appView.style.pointerEvents = <span class="string">'auto'</span>;</span><br><span class="line">    <span class="keyword">this</span>.selectedPanel.resizing = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// Nouveau rendu dans le but de déplacer tous les élements fixed et absolute</span></span><br><span class="line">    <span class="keyword">this</span>.render();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  resize(rect) &#123;</span><br><span class="line">    <span class="comment">// Change la dimension du panel</span></span><br><span class="line">    <span class="comment">// Provoque un nouveau rendu</span></span><br><span class="line">    <span class="keyword">this</span>.selectedPanel.setSize(rect);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**************************</span></span><br><span class="line"><span class="comment">   ** Gestion des panels **</span></span><br><span class="line"><span class="comment">   **************************/</span></span><br><span class="line"></span><br><span class="line"> select(panelIndex) &#123;</span><br><span class="line">   <span class="keyword">if</span>(<span class="keyword">this</span>.selectedPanel) &#123;</span><br><span class="line">     <span class="keyword">this</span>.previousPanel = <span class="keyword">this</span>.selectedPanel;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.selectedPanel = <span class="keyword">this</span>.getPanel(panelIndex);</span><br><span class="line">   <span class="keyword">this</span>.render();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">  getPanel(panelIndex) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.panels.get(panelIndex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ensureCreate() &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">this</span>.view) &#123;</span><br><span class="line">      <span class="keyword">this</span>.create();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Le changement de panel se fera donc simplement avec <code>select</code> qui s’occupera de déléguer le rendu.</p>
<figure class="highlight javascript"><figcaption><span>contentScript.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> panelScene = <span class="keyword">new</span> PanelScene();</span><br><span class="line"></span><br><span class="line">panelScene.select(<span class="string">'sidebar'</span>);</span><br><span class="line"><span class="comment">// ou ... panelScene.select('bottom');</span></span><br></pre></td></tr></table></figure>
<p>Nous avons plusieurs panels qui partagent tous des méthodes identiques. Déjà, ils doivent avoir un <code>render</code> pour styliser la scène et la page visitée, puis un <code>clear</code> pour effacer ces modifications. L’héritage semble donc tout indiqué dans notre cas.</p>
<figure class="highlight javascript"><figcaption><span>BasePanel.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Tout Panel créée devra hériter de cette classe</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasePanel</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(scene, minSize) &#123;</span><br><span class="line">    ensureAbstractMethods(<span class="keyword">this</span>, [</span><br><span class="line">      <span class="string">'restrict'</span>,</span><br><span class="line">      <span class="string">'clear'</span>,</span><br><span class="line">      <span class="string">'render'</span>,</span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.scene = scene;</span><br><span class="line">    <span class="keyword">this</span>.resizing = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.minSize = minSize;</span><br><span class="line">    <span class="keyword">this</span>.currentSize = minSize;</span><br><span class="line">    <span class="comment">// Dimension minimal (utile pour le redimensionnement)</span></span><br><span class="line">    <span class="keyword">this</span>.restrictSize = <span class="keyword">this</span>.restrict();  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Je n’évoquerai pas le BottomPanel puisque pratiquement identique à notre Sidebar.</p>
<figure class="highlight javascript"><figcaption><span>SidebarPanel.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> BasePanel <span class="keyword">from</span> <span class="string">'./BasePanel'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; setStyles, getFixedNode &#125; <span class="keyword">from</span> <span class="string">'../utils/dom'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SidebarPanel</span> <span class="keyword">extends</span> <span class="title">BasePanel</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Restriction du dimensionnement par rapport à sa largeur</span></span><br><span class="line">  restrict() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">width</span>: <span class="keyword">this</span>.minSize &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="comment">// Dimensionnement &amp;&amp; styling de la scène</span></span><br><span class="line">    <span class="comment">// Egalement appelé lors du redimensionnement</span></span><br><span class="line">    setStyles(<span class="keyword">this</span>.scene.view, &#123;</span><br><span class="line">      width: <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.currentSize&#125;</span>px`</span>,</span><br><span class="line">      top: <span class="string">'0'</span>,</span><br><span class="line">      height: <span class="string">'auto'</span>,</span><br><span class="line">      border: <span class="string">'O'</span>,</span><br><span class="line">      borderRight: <span class="string">'1px solid rgba(0, 0, 0, 0.04)'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &lt;body&gt; doit être mis en relative pour les éléments absolutes</span></span><br><span class="line">    <span class="keyword">this</span>.scene.body.setPosition(<span class="string">'relative'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.scene.root.style.marginLeft = <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.currentSize&#125;</span>px`</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Déplace les élements fixed seulement lorsque</span></span><br><span class="line">    <span class="comment">// l'on ne redimensionne pas pour des raisons de perf</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">this</span>.resizing) &#123;</span><br><span class="line">      <span class="keyword">this</span>.moveFixedNode();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Efface les modifications</span></span><br><span class="line">  clear() &#123;</span><br><span class="line">    <span class="keyword">this</span>.scene.root.style.marginLeft = <span class="string">'0'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.moveFixedNode(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">this</span>.scene.body.restorePosition();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Déplace tous les éléments fixed</span></span><br><span class="line">  moveFixedNode(forceSize) &#123;</span><br><span class="line">    <span class="keyword">const</span> size = (<span class="keyword">typeof</span> forceSize === <span class="string">'undefined'</span>) ? <span class="keyword">this</span>.currentSize : forceSize;</span><br><span class="line">    <span class="keyword">const</span> nodes = getFixedNode(<span class="function">(<span class="params">node, style</span>) =&gt;</span> node !== <span class="keyword">this</span>.scene.view);</span><br><span class="line"></span><br><span class="line">    nodes.forEach(<span class="function"><span class="params">node</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(!node.getAttribute(<span class="string">'data-ori-x'</span>)) &#123;</span><br><span class="line">        <span class="keyword">const</span> style = <span class="built_in">window</span>.getComputedStyle(node);</span><br><span class="line">        node.setAttribute(<span class="string">'data-ori-x'</span>, <span class="built_in">parseInt</span>(style.left, <span class="number">10</span>) || <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> oriX = <span class="built_in">parseInt</span>(node.getAttribute(<span class="string">'data-ori-x'</span>), <span class="number">10</span>);</span><br><span class="line">      node.style.left = <span class="string">`<span class="subst">$&#123;oriX + size&#125;</span>px`</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Determine currentSize à partir du rectangle récupéré</span></span><br><span class="line">  <span class="comment">// de l'event de redimensionnement</span></span><br><span class="line">  setSize(rect) &#123;</span><br><span class="line">    <span class="keyword">this</span>.currentSize = <span class="built_in">parseInt</span>(rect.width, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">this</span>.render();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>L’intégralité du code peut être retrouvé <a href="https://github.com/karlito40/fofo/tree/0b9c77f5bdee16607fbbfcdbd2579146e59ef227/fofo-web-ext" target="_blank" rel="noopener">ici</a>. Ce lien faisant référence à un commit en particulier, pensez à regarder la branche master pour voir si j’ai pas trouvé une meilleur façon de faire entre temps.</p>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Javascript/">
                #Javascript
              </a>
            
              <a href="/tags/WebExtension/">
                #WebExtension
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">
      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2018/09/16/web-extension-injecter-une-iframe/">
                Web extension, injecter une iframe
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posté le 16/09/2018
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <p>L’idée est d’encapsuler une application distante à l’intérieur d’un site pour lui ajouter, par exemple, une sidebar. A noter que si l’on vise seulement Firefox, on peut utiliser <code>sidebar_action</code> en manifest de notre extension. Le seul problème c’est que cette sidebar vient avec un layout non configurable.</p>
<p><strong>L’approche naïve</strong> est de créer une iframe avec source externe et de l’injecter grace à <code>document.body.append</code> dans notre <code>content_scripts</code>.</p>
<figure class="highlight javascript"><figcaption><span>contentScript.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> appExterne = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span><br><span class="line">appExterne.id = <span class="string">'encapsulateApp'</span>;</span><br><span class="line">appExterne.src = <span class="string">'https://mon-appli.com'</span>;</span><br><span class="line"><span class="built_in">document</span>.body.append(appExterne);</span><br></pre></td></tr></table></figure>
<p>Seulement, certains sites comme gmail ou github ne permettent pas de charger une frame externe et émettent une erreur <code>Content-Security-Policy</code>.</p>
<p><strong>L’approche valide</strong> est d’enregistrer l’iframe dans le manifest de l’extension.</p>
<figure class="highlight javascript"><figcaption><span>manifest.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="string">"content_scripts"</span>: [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"matches"</span>: [<span class="string">"&lt;all_urls&gt;"</span>],</span><br><span class="line">    <span class="string">"js"</span>: [<span class="string">"contentScript.js"</span>]</span><br><span class="line">  &#125;</span><br><span class="line">],</span><br><span class="line"><span class="string">"web_accessible_resources"</span>:[</span><br><span class="line">  <span class="string">"public/iframeAutorise.html"</span></span><br><span class="line">]</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>Notre iframe <code>iframeAutorise.html</code> est alors packagé avec notre extension. Plus de problème de <code>Content-Security-Policy</code> se pose.</p>
<p>Notre code devient:</p>
<figure class="highlight javascript"><figcaption><span>contentScript.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> appInterne = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span><br><span class="line">appInterne.src = chrome.runtime.getURL(<span class="string">'/public/iframeAutorise.html'</span>);</span><br><span class="line"><span class="built_in">document</span>.body.append(appInterne);</span><br></pre></td></tr></table></figure>
<p>Néanmoins, la mise à jour de l’application dépéndra du bon vouloir de l’utilisateur puisque l’iframe est intégré à l’extension. Pour palier à ce constat on va combiner deux iframes, l’une enregistré dans l’extension et l’autre servant de passerelle à l’application.</p>
<p><code>iframeAutorise.html</code> est donc limité à un échange d’information entre les deux parties: l’extension et l’application.</p>
<figure class="highlight html"><figcaption><span>iframeAutorise.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"%APP_URL%"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"pipe.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><figcaption><span>pipe.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Réception des messages</span></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'message'</span>, (e) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Renvoi des messages à l'iframe %APP_URL%</span></span><br><span class="line">  <span class="built_in">document</span>.querySelector(<span class="string">'iframe'</span>).contentWindow.postMessage(e.data, <span class="string">'*'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Notre application, désormais servit par <code>APP_URL</code>, devient maintenable comme tout site web.</p>
<p>On oublie pas de mettre à jour le manifest pour rendre accessible pipe.js et permettre à notre application d’envoyer des messages à l’extension.</p>
<figure class="highlight javascript"><figcaption><span>manifest.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="string">"web_accessible_resources"</span>:[</span><br><span class="line">  <span class="string">"public/*"</span></span><br><span class="line">],</span><br><span class="line"><span class="string">"externally_connectable"</span>: &#123;</span><br><span class="line">  <span class="string">"matches"</span>: [</span><br><span class="line">    <span class="comment">// Pour le dev</span></span><br><span class="line">    <span class="string">"*://localhost/*"</span>,</span><br><span class="line">    <span class="comment">// APP_DOMAIN à remplacer</span></span><br><span class="line">    <span class="string">"*://APP_DOMAIN/*"</span>,</span><br><span class="line">    <span class="comment">// exemple: "*://*.karlidev.fr/*"</span></span><br><span class="line">    <span class="string">"*://*.APP_DOMAIN/*"</span>  </span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>Envoyer un message de l’application vers l’extension nécessite de récupérer son ID et de créer un script en background pour y répondre. Mais comment récupérer cet ID ? Tout simplement en le passant en paramètre à l’<code>iframeAutorise</code>.</p>
<figure class="highlight javascript"><figcaption><span>contentScript.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Remarque: on remplace la variable appInterne par appTunnel</span></span><br><span class="line">appTunnel.src = chrome.runtime.getURL(<span class="string">'/public/iframeAutorise.html?extid='</span> + chrome.runtime.id);</span><br></pre></td></tr></table></figure>
<p>La création de l’iframe passerelle doit désormais se faire dynamiquement pour passer <code>extid</code> à l’application.</p>
<figure class="highlight html"><figcaption><span>iframeAutorise.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- PLUS NECESSAIRE --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- &lt;iframe src="%APP_URL%"&gt;&lt;/iframe&gt; --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"pipe.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>C’est <code>pipe.js</code> qui s’en charge.</p>
<figure class="highlight javascript"><figcaption><span>pipe.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span><br><span class="line">app.src = <span class="string">'%APP_URL%'</span> + location.search;</span><br><span class="line"><span class="built_in">document</span>.body.append(app);</span><br><span class="line"></span><br><span class="line"><span class="comment">// reste du code ...</span></span><br></pre></td></tr></table></figure>
<p>L’application peut alors appeler l’extension directement.</p>
<figure class="highlight javascript"><figcaption><span>application.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> params = <span class="keyword">new</span> URLSearchParams(<span class="built_in">window</span>.location.search)</span><br><span class="line"><span class="keyword">const</span> extid = params.get(<span class="string">'extid'</span>);</span><br><span class="line">chrome.runtime.sendMessage(extid, objetAEnvoyer, <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;&#125;);</span><br></pre></td></tr></table></figure>
<p>L’extension doit alors créer un script en background pour gérer cet appel ce qui nécessite la mise à jour de notre manifest.</p>
<figure class="highlight javascript"><figcaption><span>manifest.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="string">"background"</span>: &#123;</span><br><span class="line">  <span class="string">"scripts"</span>:[<span class="string">"background.js"</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/// ...</span></span><br></pre></td></tr></table></figure>
<p>Gestion du message en arrière plan <code>background.js</code>.</p>
<figure class="highlight javascript"><figcaption><span>background.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">chrome.runtime.onMessageExternal.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">msg, sender, sendResponse</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Reception du message</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Envoi d'un message à l'application</span></span><br><span class="line">  sendResponse(objetAEnvoyer);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Envoi d'un message à contentScript</span></span><br><span class="line">  chrome.tabs.sendMessage(sender.tab.id, objetAEnvoyer, <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Coté contentScript, l’envoi d’un message à l’application se fera avec <code>window.postMessage</code>:</p>
<figure class="highlight javascript"><figcaption><span>contentScript.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">'encapsulateApp'</span>)</span><br><span class="line">  .contentWindow</span><br><span class="line">  .postMessage(<span class="built_in">JSON</span>.stringify(objetAEnvoyer), <span class="string">'*'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// pipe.js s'occupera de redistribuer le message</span></span><br></pre></td></tr></table></figure>
<h4 id="Recapitulatif"><a href="#Recapitulatif" class="headerlink" title="Récapitulatif"></a>Récapitulatif</h4><p>Pour distribuer une application depuis une extension.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[contentScript: création d&apos;une iframeAutorisé]</span><br><span class="line">  -&gt; [iframeAutorisé: création de l&apos;iframeDistribué]</span><br><span class="line">    -&gt; [iframeDistribué: affiche l&apos;app]</span><br></pre></td></tr></table></figure>
<p>Envoi d’un message de l’extension vers l’application.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[contentScript: postMessage sur iframeAutorisé]</span><br><span class="line">  -&gt; [iframeAutorisé: renvoi postMessage sur iframeDistribué]</span><br><span class="line">    -&gt; [iframeDistribué: réception du message par l&apos;app]</span><br></pre></td></tr></table></figure>
<p>Envoi d’un message de l’application vers l’extension.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[app: chrome.runtime.sendMessage(extensionID)]</span><br><span class="line">  -&gt; [background: gestion du message]</span><br><span class="line">    | [envoi réponse à l&apos;app]</span><br><span class="line">    | [envoi nouveau message vers contentScript]</span><br></pre></td></tr></table></figure>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Javascript/">
                #Javascript
              </a>
            
              <a href="/tags/Tips/">
                #Tips
              </a>
            
              <a href="/tags/WebExtension/">
                #WebExtension
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">
      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2018/09/15/supprimer-les-doublons-d-un-tableau/">
                Supprimer les doublons d'un tableau
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posté le 15/09/2018
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <p>L’approche classique est de disposer d’un objet tampon dans lequel on va stocker l’identifiant de l’élément d’un tableau. Ainsi, à mesure que l’on parcourt le tableau, on va s’assurer que cet identifiant ne soit pas déjà présent dans l’objet en question. Si il existe, ca signifie que l’élément courant est un doublon.</p>
<p>Une première méthode est d’utiliser <code>reduce</code> ou une boucle <code>for</code> classique.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enleverDoublon</span>(<span class="params">tab, recupererIdentifiant</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dejaVue = &#123;&#125;;</span><br><span class="line">  <span class="keyword">return</span> tab.reduce(<span class="function">(<span class="params">acc, val</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> identifiant = recupererIdentifiant(val);</span><br><span class="line">    <span class="keyword">if</span>(!(identifiant <span class="keyword">in</span> dejaVue)) &#123;</span><br><span class="line">      acc.push(val);</span><br><span class="line">      dejaVue[identifiant] = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> acc;</span><br><span class="line">  &#125;, []);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">enleverDoublon([</span><br><span class="line">  &#123;<span class="attr">id</span>: <span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">id</span>: <span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">id</span>: <span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">id</span>: <span class="number">3</span>&#125;</span><br><span class="line">], o =&gt; o.id);</span><br><span class="line"><span class="comment">// retourne: [ &#123; id: 1 &#125;, &#123; id: 2 &#125;, &#123; id: 3 &#125; ]</span></span><br></pre></td></tr></table></figure>
<p>Une autre méthode plus propre mais moins performante car nécessitant la construction d’un tableau intermediaire.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enleverDoublon</span>(<span class="params">tab, recupererIdentifiant</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> map = <span class="keyword">new</span> <span class="built_in">Map</span>(tab.map(<span class="function"><span class="params">v</span> =&gt;</span> [recupererIdentifiant(v), v]));</span><br><span class="line">  <span class="keyword">return</span> [...map.values()];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">enleverDoublon([</span><br><span class="line">  &#123;<span class="attr">id</span>: <span class="number">1</span>, <span class="attr">domain</span>: <span class="string">'google.com'</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">id</span>: <span class="number">2</span>, <span class="attr">domain</span>: <span class="string">'gmail.com'</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">id</span>: <span class="number">4</span>, <span class="attr">domain</span>: <span class="string">'wikipedia.com'</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">id</span>: <span class="number">5</span>, <span class="attr">domain</span>: <span class="string">'gmail.com'</span>&#125;</span><br><span class="line">], o =&gt; o.domain);</span><br><span class="line"><span class="comment">// retourne: [&#123;id: 1, domain: "google.com"&#125;, &#123;id: 2, domain: "gmail.com"&#125;, &#123;id: 4, domain: "wikipedia.com"&#125;]</span></span><br></pre></td></tr></table></figure>
<p>Je vous laisse vous référer à la doc de <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Objets_globaux/Map" target="_blank" rel="noopener">Map</a> dans la section sur la fusion de tableau.</p>
<p>Par contre, si on veut supprimer les vrais doublons il faudra construire un identifiant réprésentant d’avantage l’élément en question. Dans le dernier exemple on se rend compte que l’objet ‘gmail.com’ est supprimé alors qu’il n’est pas tout à fait un doublon. Pour palier à ce problème on pourrait utiliser l’identifiant suivant <code>o =&gt; o.domain + &#39;-&#39; + o.id</code> ou, plus barbare, <code>o =&gt; JSON.stringify(o)</code>.</p>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Javascript/">
                #Javascript
              </a>
            
              <a href="/tags/Tips/">
                #Tips
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">
      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2018/09/13/reprise-du-blog/">
                Github Pages, déploiement d'Hexo
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posté le 13/09/2018
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <p>Eh non je ne suis pas encore mort ! Pour feter la fin de l’été je me suis dit qu’il était temps de reprendre en main ce bon vieux blog. Bon, ça ce n’est pas fait sans malheur.</p>
<p>Tout d’abord il m’a fallut batailler pour mettre à jour Hexo. Plus rien ne marchait. J’ai donc opté pour la solution radicale: repartir de zéro et corriger le thème à la main. Ca a été long et fastidieux mais voila c’est fait.</p>
<p>Bref, attelons nous au sujet principal: Github Pages.</p>
<p>Github différencie deux types de sites. L’un tourné autour de l’<strong>organisatation</strong> détenant un ensemble de repositories. L’autre, <strong>projet</strong>, décrit un repository donné.</p>
<p>Une page Github d’<strong>organisatation</strong> aura pour lien <strong>https://<code>organisation</code>.github.io</strong>. Elle ne peut être créée qu’à partir d’un repository nommé <strong><code>organisation</code>.github.io</strong> comme je l’ai fait avec le mien <a href="https://github.com/karlito40/karlito40.github.io" target="_blank" rel="noopener">repository:karlito40.github.io</a> accessible sous <a href="https://karlito40.github.io" target="_blank" rel="noopener">https://karlito40.github.io</a>. Le site ne peut être placé que sur la branche <code>master</code> du repo.</p>
<p>Une page <strong>projet</strong> est accessible sous l’adresse suivante <strong>https://<code>organisation</code>.github.io/<code>nom-du-repository-cible</code></strong>. Le site doit être placé dans le dosser <code>/</code> ou <code>/docs</code> sur la branche <code>master</code>. Github se servira de la branche <code>gh-pages</code> à défaut.</p>
<p>Ne reste plus qu’à définir un nom de domaine personnalisé. Pour cela, il suffit d’aller dans le repository en question sous la rubrique <strong>settings</strong> puis remplir la section <strong>Custom domain</strong> avec par exemple blog.karlidev.fr. Ensuite, rendez vous sur votre hebergeur de nom de domaine. Ajoutez un paramètre CNAME pointant vers <strong><code>organisation</code>.github.io</strong>.</p>
<h3 id="Etapes-a-suivre-pour-hexo"><a href="#Etapes-a-suivre-pour-hexo" class="headerlink" title="Etapes à suivre pour hexo"></a>Etapes à suivre pour hexo</h3><p>Installez le plugin de déploiement Github page</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i hexo-deployer-git --save</span><br></pre></td></tr></table></figure>
<p>Configuration du site</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">url:</span> <span class="attr">https://blog.karlidev.fr</span> <span class="comment"># votre nom de domaine customisé</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">git</span></span><br><span class="line"><span class="attr">  repo:</span> <span class="attr">https://github.com/karlito40/karlito40.github.io.git</span> <span class="comment"># à remplacer par le votre</span></span><br><span class="line"><span class="attr">  branch:</span> <span class="string">master</span> <span class="comment"># ou gh-pages dans le cas d'une page projet</span></span><br></pre></td></tr></table></figure>
<p>Créez un fichier CNAME dans <code>/source</code> pour garder le nom de domaine personnnalisé.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> blog.karlidev.fr &gt; <span class="built_in">source</span>/CNAME</span><br></pre></td></tr></table></figure>
<p>Déploiement</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo clean &amp;&amp; hexo generate &amp;&amp; hexo deploy</span><br></pre></td></tr></table></figure>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Hexo/">
                #Hexo
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  

          </div>

          
            <div class="pagination">
              <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">&raquo;</a>
            </div>
          
        </div>

        
<div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>

<div id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    

    <div class="site-overview">
      <div class="site-author motion-element">
        <img class="site-author-image" src="/images/default_avatar.jpg" alt="Karlito" />
        <p class="site-author-name">Karlito</p>
      </div>
      <p class="site-description motion-element">Node et Javascript en pratique: tutoriels, exemple et experimentation.</p>
      <div class="site-state motion-element">
        <div class="site-state-item site-state-posts">
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">articles</span>
        </div>
        <div class="site-state-item site-state-tags">
            <span class="site-state-item-count">10</span>
            <span class="site-state-item-name">tags</span>
        </div>
        <div class="site-state-item site-state-pages">
            <span class="site-state-item-count">2</span>
            <span class="site-state-item-name">pages</span>
        </div>
      </div>

      

      <div class="social-info motion-element">
        
          
            <span class="soclial-item">
              <a href="https://github.com/karlito40">GITHUB</a>
            </span>
          
            <span class="soclial-item">
              <a href="https://twitter.com/karlito40">TWITTER</a>
            </span>
          
        
      </div>

    </div>

    
  </div>
</div>


      </div>
    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp; 
  2018
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">Karlito</span>
</div>

<!--
<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Thème - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT</a>
</div>
-->





      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/dist/jquery.min.js?v=0.3.0rc1"></script>
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      $(".fancybox").fancybox();
    });
  </script>



  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  
  <script type="text/javascript">
    $(document).ready(function () {
      $.Velocity.RunSequence([
        { e: $('.brand'), p: { opacity: 1 }, o: { duration: 100 } },
        { e: $('.logo'), p: { opacity: 1, top: 0 }, o: { duration: 50} },
        { e: $('.site-title'), p: { opacity: 1, top: 0 }, o: { duration: 200, sequenceQueue: false } }
      ]);
      $('.menu-item').velocity('transition.slideDownIn', {display: null});
    });
  </script>
  

  <script type="text/javascript">
    $(document).ready(function () {
      var body = $('body');
      var isSidebarVisible = false;
      var sidebarToggle = $('.sidebar-toggle');
      var sidebarToggleLine1st = $('.sidebar-toggle-line-first')
      var sidebarToggleLine2nd = $('.sidebar-toggle-line-middle');
      var sidebarToggleLine3rd = $('.sidebar-toggle-line-last');
      var sidebar = $('.sidebar');

      var sidebarToogleLineStatusInit = {width: '100%', opacity: 1, left: 0, rotateZ: 0, top: 0};

      var sidebarToggleLine1stStatusInit = sidebarToogleLineStatusInit;
      var sidebarToggleLine1stStatusArrow = {width: '50%', rotateZ: '-45deg', top: '2px'};
      var sidebarToogleLine1stStatusClose = {width: '100%', rotateZ: '-45deg', top: '5px'};

      var sidebarToggleLine2ndStatusInit = sidebarToogleLineStatusInit;
      var sidebarToggleLine2ndStatusArrow = {width: '90%'};
      var sidebarToogleLine2ndStatusClose = {opacity: 0};

      var sidebarToggleLine3rdStatusInit = sidebarToogleLineStatusInit;
      var sidebarToggleLine3rdStatusArrow = {width: '50%', rotateZ: '45deg', top: '-2px'};
      var sidebarToogleLine3rdStatusClose = {width: '100%', rotateZ: '45deg', top: '-5px'};

      sidebatToggleMotion();
      postsListMotion();
      backToTopMotion();

      function sidebarContentMotion () {
        $('.sidebar .motion-element').velocity(
          'transition.slideRightIn',
          {stagger: 50, drag: true}
        );
      }


      function backToTopMotion () {
        var b2top = $('.back-to-top');
        b2top.on('click', function () {
          body.velocity('scroll');
        });
      }

      function sidebarShowMotion () {
        var sidebarDisplayDuration = 300;
        var sidebarWidth = '320px';

        sidebarToggleLine1st.velocity(sidebarToogleLine1stStatusClose);
        sidebarToggleLine2nd.velocity(sidebarToogleLine2ndStatusClose);
        sidebarToggleLine3rd.velocity(sidebarToogleLine3rdStatusClose);

        sidebar.velocity({width: sidebarWidth}, sidebarDisplayDuration);
        isDesktop() && body.velocity({paddingRight: sidebarWidth}, sidebarDisplayDuration);
        sidebarContentMotion();
      }

      function sidebarHideMotion () {
        isDesktop() && body.velocity({paddingRight: 0});
        sidebar.velocity('reverse');

        sidebarToggleLine1st.velocity(sidebarToggleLine1stStatusInit);
        sidebarToggleLine2nd.velocity(sidebarToggleLine2ndStatusInit);
        sidebarToggleLine3rd.velocity(sidebarToggleLine3rdStatusInit);
      };

      function postsListMotion () {
        $('.post').velocity('transition.slideDownIn', {stagger: 300, drag: true});
      }

      function sidebatToggleMotion () {
        sidebarToggle.on('click', function () {
          isSidebarVisible ? sidebarHideMotion() : sidebarShowMotion();
          isSidebarVisible = !isSidebarVisible;
        });
        sidebarToggle.hover(function () {
          if (isSidebarVisible) {return}
          sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusArrow);
          sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusArrow);
          sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusArrow);
        }, function () {
          if (isSidebarVisible) {return}
          sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusInit);
          sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusInit);
          sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusInit);
        });
      }

      function isDesktop () {
        return screen.width > 991;
      }

      function isTablet () {
        return screen.width < 992 && screen.width > 767;
      }

      function isMobile () {
        return screen.width < 767;
      }
    });
  </script>

  

  


  
  

  


  
</body>
</html>
