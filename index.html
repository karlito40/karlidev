<!doctype html>
<html class="theme-next use-motion">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>




  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.3.0rc1"/>


    <meta name="description" content="Node et Javascript en pratique: tutoriels, exemple et experimentation." />



    <meta name="keywords" content="Javascript, Node, Mongo, PHP, Go, Git, Benchmark, Developpeur web" />





    <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.3.0rc1" />


<style>
body{
	word-spacing:2px;
}

</style>


  <title> Journal de bord d'un développeur </title>
</head>

<body>
  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
    <a href="/" class="brand">
        <span class="logo">
          <i class="icon-logo"></i>
        </span>
        <span class="site-title">Karlidev</span>
    </a>
</h1>


  <ul id="menu" class="menu">
    
      
      <li class="menu-item menu-item-home">
        <a href="/">
          <i class="menu-item-icon icon-home"></i> <br />
          Accueil
        </a>
      </li>
    
      
      <li class="menu-item menu-item-archives">
        <a href="/archives">
          <i class="menu-item-icon icon-archives"></i> <br />
          Archives
        </a>
      </li>
    
      
      <li class="menu-item menu-item-tags">
        <a href="/tags">
          <i class="menu-item-icon icon-tags"></i> <br />
          Tags
        </a>
      </li>
    
  </ul>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
            
          

          <div id="posts" class="posts-expand">
            
  
    

  <div class="post post-type-normal ">
    <div class="post-header">
      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2018/09/22/web-extension-creer-une-sidebar/">
                Web extension, créer une sidebar
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posté le 22/09/2018
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <p>Dans l’épisode précédent, nous avons étudié l’<a href="/2018/09/16/web-extension-injecter-une-iframe">injection d’iframe</a> dans une Web extension. Nous savons désormais qu’il est possible d’intégrer du contenu à un site web en limitant l’altération de son style et sa structure.</p>
<p>Mon envie maintenant est de me servir de ce que nous avons appris pour créer un panel ajustable et paramétrable. Comme des images sont plus parlantes que des mots, je vous présente le prototype issue de cet article.</p>
<figure class="caption-img"><br>  <img src="/images/web-extension/sidebar-panel.png" alt="SidebarPanel"><br>  <figcaption><strong><em>SidebarPanel</em></strong> <em>Affiche un cadre (ou panel) sur le coté gauche du site visité</em></figcaption><br></figure>

<figure class="caption-img"><br>  <img src="/images/web-extension/bottom-panel.png" alt="BottomPanel"><br>  <figcaption><strong><em>BottomPanel</em></strong> <em>Affiche un cadre (ou panel) en bas du site visité</em></figcaption><br></figure>

<p>Mais là vous vous dites que la deuxième image ne fait pas référence à une sidebar. Vous vous sentez flouez par l’article. C’est normal. Lancé dans mon élan, j’ai prévu l’implémentation d’un deuxième panel: une devbar. Il m’était impossible de résister à la tentation.</p>
<h3 id="Etude-des-besoins-et-problemes-a-resoudre"><a href="#Etude-des-besoins-et-problemes-a-resoudre" class="headerlink" title="Etude des besoins et problèmes à résoudre"></a>Etude des besoins et problèmes à résoudre</h3><p>Le projet laisse le choix à l’utilisateur de naviguer entre les panels. Il doit pouvoir passer d’un type de panel à un autre dynamiquement sans avoir à relancer un build ou de recharger la page. Ces panels devront aussi être redimensionnables.</p>
<p>De ce constat, je suis parti sur un système de scène qui va s’atteler à la gestion du rendu des différents panels sélectionnables. Un peu à la React, la scène ainsi que les panels seront vues comme des composants avec une méthode de rendu et de clean. La scène s’occupera d’appeler leurs méthodes réciproques au bon moment.</p>
<p>Les panels seront injectés en position <code>fixed</code>. Le problème principal sera donc de repositionner tous les éléments du site qui arriveront derrière ce panel.</p>
<p>Dans le cas d’une sidebar, l’approche qui parrait la plus évidente est d’ajouter une transformation en translateX sur <code>&lt;html&gt;</code> d’un montant résultant de la dimension du panel. Vous pouvez essayer… ca marche… à première vue. En faite, tous les éléments en position <code>fixed</code> seront correctement repositionnés mais leur fixation ne fonctionnera plus (ils ne suivront plus le scroll). On optera plutôt pour un <code>margin-left</code> et on parcourera le dom pour déplacer tous les éléments <code>fixed</code> à la main. Un autre étape à ne pas oublier est d’ajouter la position <code>relative</code> à <code>body</code> pour les éléments <code>absolute</code>.</p>
<p>Dans le cas d’une devbar, c’est plus simple. Il nous suffit d’ajouter un padding à <code>html</code> du même montant que la dimension du panel.</p>
<h3 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h3><p>Par défaut un Content-Script d’une Web extension s’exécute en mode <code>document_idle</code>. Dans notre cas, ce n’est pas acceptable car l’on veut s’assurer que la sidebar soit affiché dès lors que la page s’ouvre, avant même que son contenu soit chargé. Pour cela, on utilisera le mode <code>document_start</code> dans notre manifest. Il faudra prendre en compte qu’au moment où le script s’executera il n’aura accès qu’a <code>&lt;html&gt;</code> à travers <code>document.documentElement</code>. L’injection du panel se fera donc dans <code>&lt;html&gt;</code> et non pas dans <code>&lt;body&gt;</code> qui lui sera accessible qu’après avoir reçu l’event <code>DOMContentLoaded</code>.</p>
<figure class="highlight javascript"><figcaption><span>manifest.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="string">"content_scripts"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"run_at"</span>: <span class="string">"document_start"</span>,</span><br><span class="line">      <span class="string">"matches"</span>: [<span class="string">"&lt;all_urls&gt;"</span>],</span><br><span class="line">      <span class="string">"js"</span>: [<span class="string">"contentScript.js"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<h3 id="Realisation"><a href="#Realisation" class="headerlink" title="Réalisation"></a>Réalisation</h3><p>Tout d’abord, on va s’attarder sur notre Scene. Comme dit précédemment, elle gère la création des panels, leurs rendus et leurs redimensionnements. Les commentaires sont là pour expliquer le procédé.</p>
<figure class="highlight javascript"><figcaption><span>PanelScene.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> interact <span class="keyword">from</span> <span class="string">'interactjs'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createElement, setStyles &#125; <span class="keyword">from</span> <span class="string">'../utils/dom'</span>;</span><br><span class="line"><span class="keyword">import</span> Body <span class="keyword">from</span> <span class="string">'../elements/Body'</span>;</span><br><span class="line"><span class="keyword">import</span> SidebarPanel <span class="keyword">from</span> <span class="string">'../panels/SidebarPanel'</span>;</span><br><span class="line"><span class="keyword">import</span> BottomPanel <span class="keyword">from</span> <span class="string">'../panels/BottomPanel'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PanelScene</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(params = &#123;&#125;) &#123;</span><br><span class="line">    <span class="comment">// La scène s'attache sur &lt;html&gt;</span></span><br><span class="line">    <span class="keyword">this</span>.root = <span class="built_in">document</span>.documentElement;</span><br><span class="line">    <span class="comment">// document.body amélioré</span></span><br><span class="line">    <span class="comment">// on lui a ajouté setPosition() pour garder en</span></span><br><span class="line">    <span class="comment">// mémoire la position initial de &lt;body&gt;</span></span><br><span class="line">    <span class="keyword">this</span>.body = Body;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Notre scene (&lt;div&gt;)</span></span><br><span class="line">    <span class="keyword">this</span>.view = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// Notre appli (&lt;iframe&gt;)</span></span><br><span class="line">    <span class="keyword">this</span>.appView = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Le dernier panel utilisé</span></span><br><span class="line">    <span class="keyword">this</span>.previousPanel = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// Le panel courant</span></span><br><span class="line">    <span class="keyword">this</span>.selectedPanel = <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Rend accessible nos panels à l'aide d'un index</span></span><br><span class="line">    <span class="keyword">this</span>.panels = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">    <span class="keyword">this</span>.panels.set(<span class="string">'sidebar'</span>, <span class="keyword">new</span> SidebarPanel(<span class="keyword">this</span>, MIN_SIDEBAR_WIDTH));</span><br><span class="line">    <span class="keyword">this</span>.panels.set(<span class="string">'bottom'</span>, <span class="keyword">new</span> BottomPanel(<span class="keyword">this</span>, MIN_BOTTOM_HEIGHT));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Création de la scene</span></span><br><span class="line">  create() &#123;</span><br><span class="line">    <span class="comment">// Créée une div en bas à gauche de l'écran</span></span><br><span class="line">    <span class="keyword">this</span>.view = createElement(<span class="string">'div'</span>, &#123;</span><br><span class="line">      id: <span class="string">`root-<span class="subst">$&#123;APP_NAME&#125;</span>`</span>,</span><br><span class="line">    &#125;, &#123; <span class="attr">border</span>: <span class="string">'0'</span>, <span class="attr">position</span>: <span class="string">'fixed'</span>, <span class="attr">bottom</span>: <span class="string">'0'</span>, <span class="attr">left</span>: <span class="string">'0'</span>, <span class="attr">zIndex</span>: <span class="string">'9999999'</span>, &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Charge le contenu du panel</span></span><br><span class="line">    <span class="keyword">this</span>.appView = createElement(<span class="string">'iframe'</span>, &#123;</span><br><span class="line">      id: APP_NAME,</span><br><span class="line">      src: chrome.runtime.getURL(<span class="string">'/public/frame.csp.html?extid='</span> + chrome.runtime.id)</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      width: <span class="string">'100%'</span>, <span class="attr">height</span>: <span class="string">'100%'</span>, <span class="attr">border</span>: <span class="string">'0'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// On créée les coins draggable du redimensionnement</span></span><br><span class="line">    <span class="keyword">this</span>.edges = createEdges();</span><br><span class="line">    <span class="built_in">Object</span>.values(<span class="keyword">this</span>.edges).forEach(<span class="function">(<span class="params">edge</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.view.append(edge);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.view.append(<span class="keyword">this</span>.appView);</span><br><span class="line">    <span class="keyword">this</span>.root.append(<span class="keyword">this</span>.view);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Intégre la lib pour redimensionner</span></span><br><span class="line">    <span class="keyword">this</span>.createResizable();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// On refait un rendu pour déplacer tous les éléments</span></span><br><span class="line">    <span class="comment">// fixed et absolute lorsque le style est chargé</span></span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'load'</span>, (event) =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.render();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="comment">// Créée le container si c'est pas déjà fait</span></span><br><span class="line">    <span class="keyword">this</span>.ensureCreate();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// La scène précédente doit supprimer tous les</span></span><br><span class="line">    <span class="comment">// styles qu'elle a injecté</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.previous) &#123;</span><br><span class="line">      <span class="keyword">this</span>.getPanel(<span class="keyword">this</span>.previous).clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Rendu du panel sélectionné</span></span><br><span class="line">    <span class="keyword">this</span>.getPanelSelected().render();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  createResizable() &#123;</span><br><span class="line">    interact(<span class="string">`#<span class="subst">$&#123;<span class="keyword">this</span>.view.id&#125;</span>`</span>)</span><br><span class="line">      .resizable(&#123;</span><br><span class="line">        edges: <span class="keyword">this</span>.edges,</span><br><span class="line">        restrictEdges: &#123;</span><br><span class="line">          outer: <span class="string">'parent'</span>,</span><br><span class="line">          endOnly: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        restrictSize: <span class="keyword">this</span>.getPanelSelected().restrict(),</span><br><span class="line">      &#125;)</span><br><span class="line">      .on(<span class="string">'resizestart'</span>, <span class="keyword">this</span>.resizeStart.bind(<span class="keyword">this</span>))</span><br><span class="line">      .on(<span class="string">'resizeend'</span>, <span class="keyword">this</span>.resizeEnd.bind(<span class="keyword">this</span>))</span><br><span class="line">      .on(<span class="string">'resizemove'</span>, (e) =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.resize(e.rect);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/************************************</span></span><br><span class="line"><span class="comment">   ** Reponse aux redimensionnements **</span></span><br><span class="line"><span class="comment">   ************************************/</span></span><br><span class="line"></span><br><span class="line">  resizeStart() &#123;</span><br><span class="line">    <span class="comment">// On supprime la gestion du curseur sur l'iframe</span></span><br><span class="line">    <span class="comment">// pour éviter qu'il ne prenne le pas sur le redimensionnement</span></span><br><span class="line">    <span class="keyword">this</span>.appView.style.pointerEvents = <span class="string">'none'</span>;</span><br><span class="line">    <span class="keyword">this</span>.getPanelSelected().resizing = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  resizeEnd() &#123;</span><br><span class="line">    <span class="keyword">this</span>.appView.style.pointerEvents = <span class="string">'auto'</span>;</span><br><span class="line">    <span class="keyword">this</span>.getPanelSelected().resizing = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// Nouveau rendu dans le but de déplacer tous les élements fixed et absolute</span></span><br><span class="line">    <span class="keyword">this</span>.render();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  resize(rect) &#123;</span><br><span class="line">    <span class="comment">// Change la dimension du panel</span></span><br><span class="line">    <span class="comment">// Provoque un nouveau rendu</span></span><br><span class="line">    <span class="keyword">this</span>.getPanelSelected().setSize(rect);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**************************</span></span><br><span class="line"><span class="comment">   ** Gestion des panels **</span></span><br><span class="line"><span class="comment">   **************************/</span></span><br><span class="line">  togglePanel() &#123;</span><br><span class="line">    <span class="keyword">const</span> type = (!<span class="keyword">this</span>.selected || <span class="keyword">this</span>.selected == <span class="string">'bottom'</span>) ? <span class="string">'sidebar'</span> : <span class="string">'bottom'</span>;</span><br><span class="line">    <span class="keyword">this</span>.setSelected(type);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getPanel(panel) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.panels.get(panel);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getPanelSelected() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getPanel(<span class="keyword">this</span>.selected);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setSelected(panel) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.selected) &#123;</span><br><span class="line">      <span class="keyword">this</span>.previous = <span class="keyword">this</span>.selected;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.selected = panel;</span><br><span class="line">    <span class="keyword">this</span>.render();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ensureCreate() &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">this</span>.view) &#123;</span><br><span class="line">      <span class="keyword">this</span>.create();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Le changement de panel se fera donc simplement avec <code>setSelected</code> qui s’occupera de déléguer le rendu.</p>
<figure class="highlight javascript"><figcaption><span>contentScript.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> panelScene = <span class="keyword">new</span> PanelScene();</span><br><span class="line"></span><br><span class="line">panelScene.setSelected(<span class="string">'sidebar'</span>);</span><br><span class="line"><span class="comment">// ou ... panelScene.setSelected('bottom');</span></span><br></pre></td></tr></table></figure>
<p>Nous avons plusieurs panels qui partagent tous des méthodes identiques. Déjà, ils doivent avoir un <code>render</code> pour styliser la scène et la page visitée, puis un <code>clear</code> pour effacer ces modifications. L’héritage semble donc tout indiqué dans notre cas.</p>
<figure class="highlight javascript"><figcaption><span>BasePanel.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Tout Panel créée devra hériter de cette classe</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasePanel</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(scene, minSize) &#123;</span><br><span class="line">    <span class="keyword">this</span>.scene = scene;</span><br><span class="line">    <span class="keyword">this</span>.resizing = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.minSize = minSize;</span><br><span class="line">    <span class="keyword">this</span>.currentSize = minSize;</span><br><span class="line">    <span class="comment">// Dimension minimal (utile pour le redimensionnement)</span></span><br><span class="line">    <span class="keyword">this</span>.restrictSize = <span class="keyword">this</span>.restrict();  </span><br><span class="line"></span><br><span class="line">    ensureAbstractMethods(<span class="keyword">this</span>, [</span><br><span class="line">      <span class="string">'restrict'</span>,</span><br><span class="line">      <span class="string">'clear'</span>,</span><br><span class="line">      <span class="string">'render'</span>,</span><br><span class="line">    ]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Je n’évoquerai pas le BottomPanel puisque pratiquement identique à notre Sidebar.</p>
<figure class="highlight javascript"><figcaption><span>SidebarPanel.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> BasePanel <span class="keyword">from</span> <span class="string">'./BasePanel'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; setStyles, getFixedNode &#125; <span class="keyword">from</span> <span class="string">'../utils/dom'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SidebarPanel</span> <span class="keyword">extends</span> <span class="title">BasePanel</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Restriction du dimensionnement par rapport à sa largeur</span></span><br><span class="line">  restrict() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">width</span>: <span class="keyword">this</span>.minSize &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="comment">// Dimensionnement &amp;&amp; styling de la scène</span></span><br><span class="line">    <span class="comment">// Egalement appelé lors du redimensionnement</span></span><br><span class="line">    setStyles(<span class="keyword">this</span>.scene.view, &#123;</span><br><span class="line">      width: <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.currentSize&#125;</span>px`</span>,</span><br><span class="line">      top: <span class="string">'0'</span>,</span><br><span class="line">      height: <span class="string">'auto'</span>,</span><br><span class="line">      border: <span class="string">'O'</span>,</span><br><span class="line">      borderRight: <span class="string">'1px solid rgba(0, 0, 0, 0.04)'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &lt;body&gt; doit être mis en relative pour les éléments absolutes</span></span><br><span class="line">    <span class="keyword">this</span>.scene.body.setPosition(<span class="string">'relative'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.scene.root.style.marginLeft = <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.currentSize&#125;</span>px`</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Déplace les élements fixed seulement lorsque</span></span><br><span class="line">    <span class="comment">// l'on ne redimensionne pas pour des raisons de perf</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">this</span>.resizing) &#123;</span><br><span class="line">      <span class="keyword">this</span>.moveFixedNode();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Efface les modifications</span></span><br><span class="line">  clear() &#123;</span><br><span class="line">    <span class="keyword">this</span>.scene.root.style.marginLeft = <span class="string">'0'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.moveFixedNode(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">this</span>.scene.body.restorePosition();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Déplace tous les éléments fixed</span></span><br><span class="line">  moveFixedNode(forceSize) &#123;</span><br><span class="line">    <span class="keyword">const</span> size = (<span class="keyword">typeof</span> forceSize === <span class="string">'undefined'</span>) ? <span class="keyword">this</span>.currentSize : forceSize;</span><br><span class="line">    <span class="keyword">const</span> nodes = getFixedNode(<span class="function">(<span class="params">node, style</span>) =&gt;</span> node !== <span class="keyword">this</span>.scene.view);</span><br><span class="line"></span><br><span class="line">    nodes.forEach(<span class="function"><span class="params">node</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(!node.getAttribute(<span class="string">'data-ori-x'</span>)) &#123;</span><br><span class="line">        <span class="keyword">const</span> style = <span class="built_in">window</span>.getComputedStyle(node);</span><br><span class="line">        node.setAttribute(<span class="string">'data-ori-x'</span>, <span class="built_in">parseInt</span>(style.left, <span class="number">10</span>) || <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> oriX = <span class="built_in">parseInt</span>(node.getAttribute(<span class="string">'data-ori-x'</span>), <span class="number">10</span>);</span><br><span class="line">      node.style.left = <span class="string">`<span class="subst">$&#123;oriX + size&#125;</span>px`</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Determine currentSize à partir du rectangle récupéré</span></span><br><span class="line">  <span class="comment">// de l'event de redimensionnement</span></span><br><span class="line">  setSize(rect) &#123;</span><br><span class="line">    <span class="keyword">this</span>.currentSize = <span class="built_in">parseInt</span>(rect.width, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">this</span>.render();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>L’intégralité du code peut être retrouvé <a href="https://github.com/karlito40/fofo/tree/ac214cbd08a46944dd97a013da913e7ee7da64a4/fofo-web-ext" target="_blank" rel="noopener">ici</a>. Ce lien faisant référence à un commit en particulier, pensez à regarder la branche master pour voir si j’ai pas trouvé une meilleur façon de faire entre temps.</p>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Javascript/">
                #Javascript
              </a>
            
              <a href="/tags/WebExtension/">
                #WebExtension
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">
      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2018/09/16/web-extension-injecter-une-iframe/">
                Web extension, injecter une iframe
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posté le 16/09/2018
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <p>L’idée est d’encapsuler une application distante à l’intérieur d’un site pour lui ajouter, par exemple, une sidebar. A noter que si l’on vise seulement Firefox, on peut utiliser <code>sidebar_action</code> en manifest de notre extension. Le seul problème c’est que cette sidebar vient avec un layout non configurable.</p>
<p><strong>L’approche naïve</strong> est de créer une iframe avec source externe et de l’injecter grace à <code>document.body.append</code> dans notre <code>content_scripts</code>.</p>
<figure class="highlight javascript"><figcaption><span>contentScript.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> appExterne = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span><br><span class="line">appExterne.id = <span class="string">'encapsulateApp'</span>;</span><br><span class="line">appExterne.src = <span class="string">'https://mon-appli.com'</span>;</span><br><span class="line"><span class="built_in">document</span>.body.append(appExterne);</span><br></pre></td></tr></table></figure>
<p>Seulement, certains sites comme gmail ou github ne permettent pas de charger une frame externe et émettent une erreur <code>Content-Security-Policy</code>.</p>
<p><strong>L’approche valide</strong> est d’enregistrer l’iframe dans le manifest de l’extension.</p>
<figure class="highlight javascript"><figcaption><span>manifest.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="string">"content_scripts"</span>: [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"matches"</span>: [<span class="string">"&lt;all_urls&gt;"</span>],</span><br><span class="line">    <span class="string">"js"</span>: [<span class="string">"contentScript.js"</span>]</span><br><span class="line">  &#125;</span><br><span class="line">],</span><br><span class="line"><span class="string">"web_accessible_resources"</span>:[</span><br><span class="line">  <span class="string">"public/iframeAutorise.html"</span></span><br><span class="line">]</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>Notre iframe <code>iframeAutorise.html</code> est alors packagé avec notre extension. Plus de problème de <code>Content-Security-Policy</code> se pose.</p>
<p>Notre code devient:</p>
<figure class="highlight javascript"><figcaption><span>contentScript.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> appInterne = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span><br><span class="line">appInterne.src = chrome.runtime.getURL(<span class="string">'/public/iframeAutorise.html'</span>);</span><br><span class="line"><span class="built_in">document</span>.body.append(appInterne);</span><br></pre></td></tr></table></figure>
<p>Néanmoins, la mise à jour de l’application dépéndra du bon vouloir de l’utilisateur puisque l’iframe est intégré à l’extension. Pour palier à ce constat on va combiner deux iframes, l’une enregistré dans l’extension et l’autre servant de passerelle à l’application.</p>
<p><code>iframeAutorise.html</code> est donc limité à un échange d’information entre les deux parties: l’extension et l’application.</p>
<figure class="highlight html"><figcaption><span>iframeAutorise.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"%APP_URL%"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"pipe.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><figcaption><span>pipe.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Réception des messages</span></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'message'</span>, (e) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Renvoi des messages à l'iframe %APP_URL%</span></span><br><span class="line">  <span class="built_in">document</span>.querySelector(<span class="string">'iframe'</span>).contentWindow.postMessage(e.data, <span class="string">'*'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Notre application, désormais servit par <code>APP_URL</code>, devient maintenable comme tout site web.</p>
<p>On oublie pas de mettre à jour le manifest pour rendre accessible pipe.js et permettre à notre application d’envoyer des messages à l’extension.</p>
<figure class="highlight javascript"><figcaption><span>manifest.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="string">"web_accessible_resources"</span>:[</span><br><span class="line">  <span class="string">"public/*"</span></span><br><span class="line">],</span><br><span class="line"><span class="string">"externally_connectable"</span>: &#123;</span><br><span class="line">  <span class="string">"matches"</span>: [</span><br><span class="line">    <span class="comment">// Pour le dev</span></span><br><span class="line">    <span class="string">"*://localhost/*"</span>,</span><br><span class="line">    <span class="comment">// APP_DOMAIN à remplacer</span></span><br><span class="line">    <span class="string">"*://APP_DOMAIN/*"</span>,</span><br><span class="line">    <span class="comment">// exemple: "*://*.karlidev.fr/*"</span></span><br><span class="line">    <span class="string">"*://*.APP_DOMAIN/*"</span>  </span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>Envoyer un message de l’application vers l’extension nécessite de récupérer son ID et de créer un script en background pour y répondre. Mais comment récupérer cet ID ? Tout simplement en le passant en paramètre à l’<code>iframeAutorise</code>.</p>
<figure class="highlight javascript"><figcaption><span>contentScript.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Remarque: on remplace la variable appInterne par appTunnel</span></span><br><span class="line">appTunnel.src = chrome.runtime.getURL(<span class="string">'/public/iframeAutorise.html?extid='</span> + chrome.runtime.id);</span><br></pre></td></tr></table></figure>
<p>La création de l’iframe passerelle doit désormais se faire dynamiquement pour passer <code>extid</code> à l’application.</p>
<figure class="highlight html"><figcaption><span>iframeAutorise.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- PLUS NECESSAIRE --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- &lt;iframe src="%APP_URL%"&gt;&lt;/iframe&gt; --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"pipe.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>C’est <code>pipe.js</code> qui s’en charge.</p>
<figure class="highlight javascript"><figcaption><span>pipe.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> params = <span class="keyword">new</span> URLSearchParams(<span class="built_in">window</span>.location.search)</span><br><span class="line"><span class="keyword">const</span> extid = params.get(<span class="string">'extid'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span><br><span class="line">app.src = <span class="string">'%APP_URL%?extid='</span> + extid;</span><br><span class="line"><span class="built_in">document</span>.body.append(app);</span><br><span class="line"></span><br><span class="line"><span class="comment">// reste du code ...</span></span><br></pre></td></tr></table></figure>
<p>L’application peut alors appeler l’extension directement.</p>
<figure class="highlight javascript"><figcaption><span>application.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> params = <span class="keyword">new</span> URLSearchParams(<span class="built_in">window</span>.location.search)</span><br><span class="line"><span class="keyword">const</span> extid = params.get(<span class="string">'extid'</span>);</span><br><span class="line">chrome.runtime.sendMessage(extid, objetAEnvoyer, <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;&#125;);</span><br></pre></td></tr></table></figure>
<p>L’extension doit alors créer un script en background pour gérer cet appel ce qui nécessite la mise à jour de notre manifest.</p>
<figure class="highlight javascript"><figcaption><span>manifest.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="string">"background"</span>: &#123;</span><br><span class="line">  <span class="string">"scripts"</span>:[<span class="string">"background.js"</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/// ...</span></span><br></pre></td></tr></table></figure>
<p>Gestion du message en arrière plan <code>background.js</code>.</p>
<figure class="highlight javascript"><figcaption><span>background.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">chrome.runtime.onMessageExternal.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">msg, sender, sendResponse</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Reception du message</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Envoi d'un message à l'application</span></span><br><span class="line">  sendResponse(objetAEnvoyer);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Envoi d'un message à contentScript</span></span><br><span class="line">  chrome.tabs.sendMessage(sender.tab.id, objetAEnvoyer, <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Coté contentScript, l’envoi d’un message à l’application se fera avec <code>window.postMessage</code>:</p>
<figure class="highlight javascript"><figcaption><span>contentScript.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">'encapsulateApp'</span>)</span><br><span class="line">  .contentWindow</span><br><span class="line">  .postMessage(<span class="built_in">JSON</span>.stringify(objetAEnvoyer), <span class="string">'*'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// pipe.js s'occupera de redistribuer le message</span></span><br></pre></td></tr></table></figure>
<h4 id="Recapitulatif"><a href="#Recapitulatif" class="headerlink" title="Récapitulatif"></a>Récapitulatif</h4><p>Pour distribuer une application depuis une extension.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[contentScript: création d&apos;une iframeAutorisé]</span><br><span class="line">  -&gt; [iframeAutorisé: création de l&apos;iframeDistribué]</span><br><span class="line">    -&gt; [iframeDistribué: affiche l&apos;app]</span><br></pre></td></tr></table></figure>
<p>Envoi d’un message de l’extension vers l’application.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[contentScript: postMessage sur iframeAutorisé]</span><br><span class="line">  -&gt; [iframeAutorisé: renvoi postMessage sur iframeDistribué]</span><br><span class="line">    -&gt; [iframeDistribué: réception du message par l&apos;app]</span><br></pre></td></tr></table></figure>
<p>Envoi d’un message de l’application vers l’extension.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[app: chrome.runtime.sendMessage(extensionID)]</span><br><span class="line">  -&gt; [background: gestion du message]</span><br><span class="line">    | [envoi réponse à l&apos;app]</span><br><span class="line">    | [envoi nouveau message vers contentScript]</span><br></pre></td></tr></table></figure>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Javascript/">
                #Javascript
              </a>
            
              <a href="/tags/Tips/">
                #Tips
              </a>
            
              <a href="/tags/WebExtension/">
                #WebExtension
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">
      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2018/09/15/supprimer-les-doublons-d-un-tableau/">
                Supprimer les doublons d'un tableau
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posté le 15/09/2018
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <p>L’approche classique est de disposer d’un objet tampon dans lequel on va stocker l’identifiant de l’élément d’un tableau. Ainsi, à mesure que l’on parcourt le tableau, on va s’assurer que cet identifiant ne soit pas déjà présent dans l’objet en question. Si il existe, ca signifie que l’élément courant est un doublon.</p>
<p>Une première méthode est d’utiliser <code>reduce</code> ou une boucle <code>for</code> classique.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enleverDoublon</span>(<span class="params">tab, recupererIdentifiant</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dejaVue = &#123;&#125;;</span><br><span class="line">  <span class="keyword">return</span> tab.reduce(<span class="function">(<span class="params">acc, val</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> identifiant = recupererIdentifiant(val);</span><br><span class="line">    <span class="keyword">if</span>(!(identifiant <span class="keyword">in</span> dejaVue)) &#123;</span><br><span class="line">      acc.push(val);</span><br><span class="line">      dejaVue[identifiant] = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> acc;</span><br><span class="line">  &#125;, []);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">enleverDoublon([</span><br><span class="line">  &#123;<span class="attr">id</span>: <span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">id</span>: <span class="number">2</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">id</span>: <span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">id</span>: <span class="number">3</span>&#125;</span><br><span class="line">], o =&gt; o.id);</span><br><span class="line"><span class="comment">// retourne: [ &#123; id: 1 &#125;, &#123; id: 2 &#125;, &#123; id: 3 &#125; ]</span></span><br></pre></td></tr></table></figure>
<p>Une autre méthode plus propre mais moins performante car nécessitant la construction d’un tableau intermediaire.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enleverDoublon</span>(<span class="params">tab, recupererIdentifiant</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> map = <span class="keyword">new</span> <span class="built_in">Map</span>(tab.map(<span class="function"><span class="params">v</span> =&gt;</span> [recupererIdentifiant(v), v]));</span><br><span class="line">  <span class="keyword">return</span> [...map.values()];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">enleverDoublon([</span><br><span class="line">  &#123;<span class="attr">id</span>: <span class="number">1</span>, <span class="attr">domain</span>: <span class="string">'google.com'</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">id</span>: <span class="number">2</span>, <span class="attr">domain</span>: <span class="string">'gmail.com'</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">id</span>: <span class="number">4</span>, <span class="attr">domain</span>: <span class="string">'wikipedia.com'</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">id</span>: <span class="number">5</span>, <span class="attr">domain</span>: <span class="string">'gmail.com'</span>&#125;</span><br><span class="line">], o =&gt; o.domain);</span><br><span class="line"><span class="comment">// retourne: [&#123;id: 1, domain: "google.com"&#125;, &#123;id: 2, domain: "gmail.com"&#125;, &#123;id: 4, domain: "wikipedia.com"&#125;]</span></span><br></pre></td></tr></table></figure>
<p>Je vous laisse vous référer à la doc de <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Objets_globaux/Map" target="_blank" rel="noopener">Map</a> dans la section sur la fusion de tableau.</p>
<p>Par contre, si on veut supprimer les vrais doublons il faudra construire un identifiant réprésentant d’avantage l’élément en question. Dans le dernier exemple on se rend compte que l’objet ‘gmail.com’ est supprimé alors qu’il n’est pas tout à fait un doublon. Pour palier à ce problème on pourrait utiliser l’identifiant suivant <code>o =&gt; o.domain + &#39;-&#39; + o.id</code> ou, plus barbare, <code>o =&gt; JSON.stringify(o)</code>.</p>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Javascript/">
                #Javascript
              </a>
            
              <a href="/tags/Tips/">
                #Tips
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">
      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2018/09/13/reprise-du-blog/">
                Github Pages, déploiement d'Hexo
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posté le 13/09/2018
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <p>Eh non je ne suis pas encore mort ! Pour feter la fin de l’été je me suis dit qu’il était temps de reprendre en main ce bon vieux blog. Bon, ça ce n’est pas fait sans malheur.</p>
<p>Tout d’abord il m’a fallut batailler pour mettre à jour Hexo. Plus rien ne marchait. J’ai donc opté pour la solution radicale: repartir de zéro et corriger le thème à la main. Ca a été long et fastidieux mais voila c’est fait.</p>
<p>Bref, attelons nous au sujet principal: Github Pages.</p>
<p>Github différencie deux types de sites. L’un tourné autour de l’<strong>organisatation</strong> détenant un ensemble de repositories. L’autre, <strong>projet</strong>, décrit un repository donné.</p>
<p>Une page Github d’<strong>organisatation</strong> aura pour lien <strong>https://<code>organisation</code>.github.io</strong>. Elle ne peut être créée qu’à partir d’un repository nommé <strong><code>organisation</code>.github.io</strong> comme je l’ai fait avec le mien <a href="https://github.com/karlito40/karlito40.github.io" target="_blank" rel="noopener">repository:karlito40.github.io</a> accessible sous <a href="https://karlito40.github.io" target="_blank" rel="noopener">https://karlito40.github.io</a>. Le site ne peut être placé que sur la branche <code>master</code> du repo.</p>
<p>Une page <strong>projet</strong> est accessible sous l’adresse suivante <strong>https://<code>organisation</code>.github.io/<code>nom-du-repository-cible</code></strong>. Le site doit être placé dans le dosser <code>/</code> ou <code>/docs</code> sur la branche <code>master</code>. Github se servira de la branche <code>gh-pages</code> à défaut.</p>
<p>Ne reste plus qu’à définir un nom de domaine personnalisé. Pour cela, il suffit d’aller dans le repository en question sous la rubrique <strong>settings</strong> puis remplir la section <strong>Custom domain</strong> avec par exemple blog.karlidev.fr. Ensuite, rendez vous sur votre hebergeur de nom de domaine. Ajoutez un paramètre CNAME pointant vers <strong><code>organisation</code>.github.io</strong>.</p>
<h3 id="Etapes-a-suivre-pour-hexo"><a href="#Etapes-a-suivre-pour-hexo" class="headerlink" title="Etapes à suivre pour hexo"></a>Etapes à suivre pour hexo</h3><p>Installez le plugin de déploiement Github page</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i hexo-deployer-git --save</span><br></pre></td></tr></table></figure>
<p>Configuration du site</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">url:</span> <span class="attr">https://blog.karlidev.fr</span> <span class="comment"># votre nom de domaine customisé</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">git</span></span><br><span class="line"><span class="attr">  repo:</span> <span class="attr">https://github.com/karlito40/karlito40.github.io.git</span> <span class="comment"># à remplacer par le votre</span></span><br><span class="line"><span class="attr">  branch:</span> <span class="string">master</span> <span class="comment"># ou gh-pages dans le cas d'une page projet</span></span><br></pre></td></tr></table></figure>
<p>Créez un fichier CNAME dans <code>/source</code> pour garder le nom de domaine personnnalisé.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> blog.karlidev.fr &gt; <span class="built_in">source</span>/CNAME</span><br></pre></td></tr></table></figure>
<p>Déploiement</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo clean &amp;&amp; hexo generate &amp;&amp; hexo deploy</span><br></pre></td></tr></table></figure>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Hexo/">
                #Hexo
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">
      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/08/15/codepen/">
                Une nouvelle aventure commence
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posté le 15/08/2015
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <p>Aujourd’hui le monde va changer. Aujourd’hui votre vie va être bouleversé. Aujourd’hui je déclare mon  <a href="http://codepen.io/karlito40/" target="_blank" rel="noopener">Codepen</a> ouvert !<br>Alléluia.</p>
<p><img src="http://blog.codepen.io/wp-content/uploads/2012/06/Black-Small.png"></p>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Blabla/">
                #Blabla
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">
      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/03/20/restful-api/">
                Créer une API avec Node
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posté le 20/03/2015
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <p>Personnellement, j’ai toujours préféré réinventer la roue plutôt que d’utiliser un module déjà tout fait ou de copier/coller du code. L’intérêt est évidemment d’avoir quelque chose d’entièrement customisable, mais le but est aussi d’acquérir une connaissance pratique et une experience sur des systèmes qu’on sera ammené à utiliser tot ou tard (ici les apis).</p>
<p>Aujourd’hui, je vous propose donc d’implémenter les bases d’une api avec <strong>node</strong>, <strong>express</strong> et <strong>mongo</strong>. Let’s go !</p>
          <div class="post-more-link center">
            <a class="btn" href="/2015/03/20/restful-api/#more">
              Lire la suite &raquo;
            </a>
          </div>
        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Node/">
                #Node
              </a>
            
              <a href="/tags/Express/">
                #Express
              </a>
            
              <a href="/tags/Mongo/">
                #Mongo
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">
      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/03/18/deploy-heroku/">
                Heroku, déploiement d'Hexo
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posté le 18/03/2015
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <p>Heroku est connu pour faciliter le déploiement d’application. On peut désormais se concenter uniquement sur les choses qui nous intéressent au lieu d’avoir à configurer nos serveurs et d’en prévoir la scalabilité.</p>
<p>Aujourd’hui, nous allons voir comment déployer notre blog sans le moindre frais et de manière scalable en quelques secondes.</p>
<h3 id="Bien-commencer"><a href="#Bien-commencer" class="headerlink" title="Bien commencer"></a>Bien commencer</h3><p>Tout d’abord allez sur <a href="https://www.heroku.com" target="_blank" rel="noopener">Heroku</a> et ouvrez votre compte gratuit. Avant d’aller plus loin, assurez vous d’avoir <strong>node</strong>, <strong>npm</strong>, <strong>git</strong> et <strong>l’utilitaire heroku</strong> sur votre machine.</p>
<p>Sous debian, l’utilitaire heroku se récupère ainsi:</p>
<figure class="highlight bash"><figcaption><span>install heroku</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget -qO- https://toolbelt.heroku.com/install-ubuntu.sh | sh</span><br></pre></td></tr></table></figure>
<p>Vous devriez maintenant être capable d’accéder à la ligne de commande d’heroku.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ heroku</span><br></pre></td></tr></table></figure>
<p><img src="/images/heroku-cmd.png"></p>
<p>Il ne vous reste plus qu’à vous authentifier pour la première et dernière fois.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ heroku login</span><br></pre></td></tr></table></figure>
<h3 id="Git-amp-Heroku"><a href="#Git-amp-Heroku" class="headerlink" title="Git &amp; Heroku"></a>Git &amp; Heroku</h3><p>L’un des points forts d’Heroku est d’être parfaitement intégré à git ce qui va nous faciliter la vie. Un push et nos changement sont en prod !</p>
<p>Nous allons maintenant essayer de déployer notre blog fraichement créée. Placez vous à la racine de votre blog et executez la ligne suivante:</p>
<figure class="highlight bash"><figcaption><span>init-repo</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git init</span><br></pre></td></tr></table></figure>
<p>Profitez en pour ajouter un repo externe.</p>
<figure class="highlight plain"><figcaption><span>add-remote</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git remote add origin https://github.com/karlito40/hexo-tuto.git</span><br></pre></td></tr></table></figure>
<p>Dans le même temps, on va créer un autre repo externe appelé “heroku”. Tout ça est généré automatiquement par heroku grace à la commande suivante:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ heroku create hexo-tuto</span><br></pre></td></tr></table></figure>
<p>L’appli hexo-tuto devrait alors apparaitre dans votre administration heroku et un nouveau repo externe a du être ajouté à votre code.</p>
<figure class="highlight bash"><figcaption><span>check-remote</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git remote -v</span><br></pre></td></tr></table></figure>
<h3 id="Particularite-d’hexo"><a href="#Particularite-d’hexo" class="headerlink" title="Particularité d’hexo"></a>Particularité d’hexo</h3><p>Je vous déconseille fortement d’utiliser la fonctionnalité d’hexo censé faciliter le déploiement (hexo deploy) celle ci étant particulièrement buggé lorsqu’il s’agit de faire des mises à jours. Le plus simple reste d’instancier soit-même le serveur. Pour cela, nous allons créer un nouveau fichier <strong>app.js</strong> et profiter de <strong>connect</strong> pour démarrer le serveur.</p>
<figure class="highlight javascript"><figcaption><span>app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> connect = <span class="built_in">require</span>(<span class="string">'connect'</span>),</span><br><span class="line">  app = connect.createServer(),</span><br><span class="line">  port = process.env.PORT || <span class="number">4000</span>;</span><br><span class="line"></span><br><span class="line">app.use(connect.static(__dirname + <span class="string">'/public'</span>));</span><br><span class="line">app.use(connect.compress());</span><br><span class="line"></span><br><span class="line">app.listen(port, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Hexo is running on port %d'</span>, port);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>On pense à ajouter <strong>“connect”:”2.x”</strong> dans les dépendances de notre <strong>package.json</strong> et à générer le contenu static d’hexo avant de pusher sur heroku.</p>
<figure class="highlight bash"><figcaption><span>generate-static-files</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>Le <strong>gitignore</strong> doit également être modifié puisqu’on ne se sert pas du built-in deploy.</p>
<figure class="highlight plain"><figcaption><span>.gitignore</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.DS_Store</span><br><span class="line">Thumbs.db</span><br><span class="line">debug.log</span><br><span class="line">node_modules/</span><br><span class="line">.deploy/</span><br></pre></td></tr></table></figure>
<h3 id="Deployer-votre-app"><a href="#Deployer-votre-app" class="headerlink" title="Déployer votre app"></a>Déployer votre app</h3><p>Par defaut, heroku ira chercher la commande d’instanciation de notre application dans <strong>package.json</strong> section <strong>scripts</strong> index <strong>start</strong>. On peut également définir cette commande particulière dans un fichier <strong>Procfile</strong> spécialement dédié à heroku. De ce fait, si vous n’avez pas d’index <strong>start</strong> vous pouvez tout à fait définir un Procfile chargé d’executer notre app:</p>
<figure class="highlight bash"><figcaption><span>Procfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web: node app</span><br></pre></td></tr></table></figure>
<p>Voila, notre déploiement est enfin prêt ! Il nous reste plus qu’à pusher notre app sur le repository d’heroku:</p>
<figure class="highlight bash"><figcaption><span>deploy-to-heroku</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">"Deploy"</span></span><br><span class="line">$ git push heroku master</span><br></pre></td></tr></table></figure>
<p>Admirez le travail: <a href="https://hexo-tuto2.herokuapp.com/" target="_blank" rel="noopener">https://hexo-tuto2.herokuapp.com/</a>.</p>
<h2 id="Eviter-l’endormissement-des-instances-gratuites"><a href="#Eviter-l’endormissement-des-instances-gratuites" class="headerlink" title="Eviter l’endormissement des instances gratuites"></a>Eviter l’endormissement des instances gratuites</h2><p>Vous avez peut être remarqué que votre site met un certains temps avant de démarrer. Pas de panique, c’est normal. Heroku a tendance à endormir les instances gratuites au bout d’une dizaine de minutes si trop peu de requêtes sont enregistrées. Par ailleurs, ce système peut facilement être contourné à l’aide de <a href="http://kaffeine.herokuapp.com/" target="_blank" rel="noopener">Kaffeine</a> qui va se charger de pinger votre instance toutes les X minutes :)</p>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Heroku/">
                #Heroku
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">
      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/02/22/hexo-blog/">
                Hexo, un blog en markdown
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posté le 22/02/2015
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <p>Si comme moi vous êtes rebuté par les back offices et les usines à gaz facon wordpress alors <a href="http://hexo.io/" target="_blank" rel="noopener">Hexo</a> est fait pour vous. Ici, pas de base de données, seulement du json et du markdown simple. Plus besoin de se connecter ou de lancer un serveur pour rédiger et formater son article. Le bloc note sera notre seul et unique outil. Besoin d’un exemple ? C’est partit.</p>
<figure class="highlight plain"><figcaption><span>mon-article</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">title: Hexo, un blog en markdown</span><br><span class="line">date: 2015-02-22 18:29:50</span><br><span class="line">tags:</span><br><span class="line">- Hexo</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">Si vous êtes rebuté par les back offices et les ..</span><br></pre></td></tr></table></figure>
<p>Génial non ? L’entête de notre article est délimité par les trois “-“ et le reste du contenu utilisera du mardown simple. Nous allons maintenant voir comment créer entièrement un blog sous hexo en moins de 5 minutes.</p>
<h3 id="Utilisation-de-base"><a href="#Utilisation-de-base" class="headerlink" title="Utilisation de base"></a>Utilisation de base</h3><p>C’est le moment d’installer node si vous l’avez pas déjà fait sinon vous pouvez dès à présent récupérer hexo comme ci-dessous:</p>
<figure class="highlight bash"><figcaption><span>install-hexo</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install -g hexo</span><br></pre></td></tr></table></figure>
<p>Installer hexo globalement vous permet d’avoir accès à sa ligne de commande. Il est ainsi aisé de créer un blog à partir de zéro.</p>
<figure class="highlight bash"><figcaption><span>init-blog</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ hexo init project-test</span><br><span class="line">$ <span class="built_in">cd</span> project-test</span><br><span class="line">$ npm install</span><br></pre></td></tr></table></figure>
<p>Tadam, vous avez maintenant un blog prêt à être utilisé. Elle est pas belle la vie ? Vous ne me croyez pas ? Alors lancez cette commande.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>Et observez le résultat dans votre navigateur préféré <a href="http://localhost:4000" target="_blank" rel="noopener">check</a>.</p>
<p><img src="/images/screen1.png" alt=""></p>
<p>Un blog sans article est un peu… fade. Il est temps de passer à l’action è.é</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new post <span class="string">"un super post"</span></span><br></pre></td></tr></table></figure>
<p>Votre article est alors créée dans /source/_posts/un-super-post.md et enregistré dans le fichier /db.json. Toutes modifications faites dans un-super-post.md seront néanmoins prises en compte. Les tags et les catégories sont automatiquement gérés dans l’entête de ce dernier.</p>
<h3 id="Image"><a href="#Image" class="headerlink" title="Image"></a>Image</h3><p>Pour uploader vos propres images, le plus simple reste de les intégrer au dossier /themes/(theme_courant)/source/images. Actuellement votre theme courant est sans doute “landscape”. Votre contenu aura ainsi accès à vos images sans avoir à passer par un prestataire externe (imgur, etc..).</p>
<figure class="highlight markdown"><figcaption><span>utilisation-image.md</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Et observez le résultat dans votre navigateur préféré [<span class="string">check</span>](<span class="link">http://localhost:4000</span>).</span><br><span class="line"></span><br><span class="line">&lt;img class="full-image" src="/images/screen1.png" alt=""&gt;</span><br></pre></td></tr></table></figure>
<p>A noter, j’utilise ici la balise img au lieu du markdown prévu à cet effet pour spécifier un attribut class. Si jamais vous en avez besoin, voici comment on intègre une image en markdown.</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![<span class="string">alt_text</span>](<span class="link">/images/screen1.png</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Gestion-des-themes"><a href="#Gestion-des-themes" class="headerlink" title="Gestion des thèmes"></a>Gestion des thèmes</h3><p>Hexo vient avec un gestionnaire de thème assez simple à utiliser. La liste des thèmes est accessible <a href="https://github.com/hexojs/hexo/wiki/themes" target="_blank" rel="noopener">ici</a>. Si nous prenons par exemple le cas d’<a href="http://foreachsam.github.io/blog-framework-semantic-ui/article/" target="_blank" rel="noopener">Aiki</a> il nous suffit de dézipper ou de cloner son <a href="https://github.com/foreachsam/hexo-theme-aiki" target="_blank" rel="noopener">repo</a> dans /themes/</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/foreachsam/hexo-theme-aiki.git themes/aiki</span><br></pre></td></tr></table></figure>
<p>La deuxième partie de commande themes/aiki dépend évidemment de votre chemin courant.</p>
<p>Il ne vous reste plus qu’à spécifier ce thème dans /_config.yml</p>
<figure class="highlight bash"><figcaption><span>yaml _config.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">theme: aiki</span><br></pre></td></tr></table></figure>
<p>Petite précision, le nom du thème correspond à son nom de dossier.</p>
<p>Voila, c’est finit pour aujourd’hui ! Le but du prochain post sera de déployer ce blog pour 0€ :D</p>
<p><img src="/images/screen2.png" alt=""></p>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Hexo/">
                #Hexo
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  
    

  <div class="post post-type-normal ">
    <div class="post-header">
      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/02/21/hello-world/">
                Un développeur sauvage apparaît
              </a>
            
          
        </h1>
      

      <div class="post-meta">
          <span class="post-time">
            
              Posté le 21/02/2015
            
          </span>
        
          
        
      </div>
    </div>

    
      <div class="post-body">

        
        

        
          <p>Il était une fois au pays du code binaire et des accolades, un petit développeur soucieux d’apprendre et de partager ses quelques connaissances. Ensemble nous allons partir à la conquête du javascript, go, git, mongo, node et bien d’autres choses.</p>
<p>N’hésitez pas à me suivre sur <a href="https://https://twitter.com/karlito40" target="_blank" rel="noopener">twitter</a> si  le coeur vous en dit. Hakuna matata à vous.</p>
<p><img src="/images/kitty.jpg"></p>

        

      </div>
    

    
      <div class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Blabla/">
                #Blabla
              </a>
            
          </div>
        

        

        
          <div class="post-eof the-shape"></div>
        
      </div>
    
  </div>


  

          </div>

          
        </div>

        
<div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>

<div id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    

    <div class="site-overview">
      <div class="site-author motion-element">
        <img class="site-author-image" src="/images/default_avatar.jpg" alt="Karlito" />
        <p class="site-author-name">Karlito</p>
      </div>
      <p class="site-description motion-element">Node et Javascript en pratique: tutoriels, exemple et experimentation.</p>
      <div class="site-state motion-element">
        <div class="site-state-item site-state-posts">
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">articles</span>
        </div>
        <div class="site-state-item site-state-tags">
            <span class="site-state-item-count">9</span>
            <span class="site-state-item-name">tags</span>
        </div>
        <div class="site-state-item site-state-pages">
            <span class="site-state-item-count">2</span>
            <span class="site-state-item-name">pages</span>
        </div>
      </div>

      

      <div class="social-info motion-element">
        
          
            <span class="soclial-item">
              <a href="https://github.com/karlito40">GITHUB</a>
            </span>
          
            <span class="soclial-item">
              <a href="https://twitter.com/karlito40">TWITTER</a>
            </span>
          
        
      </div>

    </div>

    
  </div>
</div>


      </div>
    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp; 
  2018
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">Karlito</span>
</div>

<!--
<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Thème - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT</a>
</div>
-->





      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/dist/jquery.min.js?v=0.3.0rc1"></script>
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      $(".fancybox").fancybox();
    });
  </script>



  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  
  <script type="text/javascript">
    $(document).ready(function () {
      $.Velocity.RunSequence([
        { e: $('.brand'), p: { opacity: 1 }, o: { duration: 100 } },
        { e: $('.logo'), p: { opacity: 1, top: 0 }, o: { duration: 50} },
        { e: $('.site-title'), p: { opacity: 1, top: 0 }, o: { duration: 200, sequenceQueue: false } }
      ]);
      $('.menu-item').velocity('transition.slideDownIn', {display: null});
    });
  </script>
  

  <script type="text/javascript">
    $(document).ready(function () {
      var body = $('body');
      var isSidebarVisible = false;
      var sidebarToggle = $('.sidebar-toggle');
      var sidebarToggleLine1st = $('.sidebar-toggle-line-first')
      var sidebarToggleLine2nd = $('.sidebar-toggle-line-middle');
      var sidebarToggleLine3rd = $('.sidebar-toggle-line-last');
      var sidebar = $('.sidebar');

      var sidebarToogleLineStatusInit = {width: '100%', opacity: 1, left: 0, rotateZ: 0, top: 0};

      var sidebarToggleLine1stStatusInit = sidebarToogleLineStatusInit;
      var sidebarToggleLine1stStatusArrow = {width: '50%', rotateZ: '-45deg', top: '2px'};
      var sidebarToogleLine1stStatusClose = {width: '100%', rotateZ: '-45deg', top: '5px'};

      var sidebarToggleLine2ndStatusInit = sidebarToogleLineStatusInit;
      var sidebarToggleLine2ndStatusArrow = {width: '90%'};
      var sidebarToogleLine2ndStatusClose = {opacity: 0};

      var sidebarToggleLine3rdStatusInit = sidebarToogleLineStatusInit;
      var sidebarToggleLine3rdStatusArrow = {width: '50%', rotateZ: '45deg', top: '-2px'};
      var sidebarToogleLine3rdStatusClose = {width: '100%', rotateZ: '45deg', top: '-5px'};

      sidebatToggleMotion();
      postsListMotion();
      backToTopMotion();

      function sidebarContentMotion () {
        $('.sidebar .motion-element').velocity(
          'transition.slideRightIn',
          {stagger: 50, drag: true}
        );
      }


      function backToTopMotion () {
        var b2top = $('.back-to-top');
        b2top.on('click', function () {
          body.velocity('scroll');
        });
      }

      function sidebarShowMotion () {
        var sidebarDisplayDuration = 300;
        var sidebarWidth = '320px';

        sidebarToggleLine1st.velocity(sidebarToogleLine1stStatusClose);
        sidebarToggleLine2nd.velocity(sidebarToogleLine2ndStatusClose);
        sidebarToggleLine3rd.velocity(sidebarToogleLine3rdStatusClose);

        sidebar.velocity({width: sidebarWidth}, sidebarDisplayDuration);
        isDesktop() && body.velocity({paddingRight: sidebarWidth}, sidebarDisplayDuration);
        sidebarContentMotion();
      }

      function sidebarHideMotion () {
        isDesktop() && body.velocity({paddingRight: 0});
        sidebar.velocity('reverse');

        sidebarToggleLine1st.velocity(sidebarToggleLine1stStatusInit);
        sidebarToggleLine2nd.velocity(sidebarToggleLine2ndStatusInit);
        sidebarToggleLine3rd.velocity(sidebarToggleLine3rdStatusInit);
      };

      function postsListMotion () {
        $('.post').velocity('transition.slideDownIn', {stagger: 300, drag: true});
      }

      function sidebatToggleMotion () {
        sidebarToggle.on('click', function () {
          isSidebarVisible ? sidebarHideMotion() : sidebarShowMotion();
          isSidebarVisible = !isSidebarVisible;
        });
        sidebarToggle.hover(function () {
          if (isSidebarVisible) {return}
          sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusArrow);
          sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusArrow);
          sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusArrow);
        }, function () {
          if (isSidebarVisible) {return}
          sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusInit);
          sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusInit);
          sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusInit);
        });
      }

      function isDesktop () {
        return screen.width > 991;
      }

      function isTablet () {
        return screen.width < 992 && screen.width > 767;
      }

      function isMobile () {
        return screen.width < 767;
      }
    });
  </script>

  

  


  
  

  


  
</body>
</html>
